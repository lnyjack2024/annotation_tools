{"ast":null,"code":"import { makeAutoObservable } from 'mobx';\nimport { message } from 'antd';\nimport { AttributesMode } from '../types';\nimport Relationship from '../model/Relationship';\nimport Connection from '../view/Connection';\nimport i18n from '../locales';\nimport { CAMERA_VIEW_CONNECTIONS } from '../constants';\nimport { formatFrames } from '../utils';\nexport default class RelationshipStore {\n  /**\n   * is relationship enabled\n   * @getter\n   */\n  get relationshipEnabled() {\n    return this.options.length > 0;\n  }\n\n  /**\n   * is setting relationship\n   * @getter\n   */\n  get settingRelationship() {\n    return this.fromInstanceItem !== null;\n  }\n\n  /**\n   * editing connection\n   * @getter\n   */\n  get editingConnection() {\n    if (!this.editingRelationship) {\n      return undefined;\n    }\n    const cid = this.connectionMap[this.editingRelationship.id];\n    return this.connections[cid];\n  }\n  constructor(rootStore) {\n    /**\n     * root store\n     */\n    this.rootStore = void 0;\n    /**\n     * relationship options\n     */\n    this.options = [];\n    /**\n     * active option index\n     */\n    this.activeOptionIndex = 0;\n    /**\n     * saved relationships\n     */\n    this.relationships = [];\n    /**\n     * editing relationship\n     */\n    this.editingRelationship = null;\n    /**\n     * relationship menu position\n     */\n    this.menuPosition = null;\n    /**\n     * from instance item current editing\n     */\n    this.fromInstanceItem = null;\n    /**\n     * from instance item relationship icon\n     */\n    this.fromIcon = null;\n    /**\n     * current editing connection\n     */\n    this.currentConnection = null;\n    /**\n     * all onnection instances in current frame & current camera\n     */\n    this.connections = {};\n    /**\n     * relationship id & connection id mapping\n     */\n    this.connectionMap = {};\n    /**\n     * visible connection ids\n     */\n    this.visibleConnectionIds = [];\n    /**\n     * handle mouse move\n     * @param event\n     */\n    this.handleMouseMove = event => {\n      if (this.settingRelationship) {\n        const to = {\n          x: event.clientX,\n          y: event.clientY\n        };\n        if (!this.currentConnection) {\n          const fromRect = this.fromIcon.getBoundingClientRect();\n          const from = {\n            x: fromRect.x + fromRect.width,\n            y: fromRect.y + fromRect.height / 2\n          };\n          this.currentConnection = new Connection({\n            containerId: `${CAMERA_VIEW_CONNECTIONS}-${this.rootStore.frame.currentCamera}`,\n            from,\n            to,\n            text: this.options[this.activeOptionIndex].name\n          });\n        } else {\n          this.currentConnection.to = to;\n        }\n      }\n    };\n    /**\n     * handle relationship click\n     * @param relationship\n     */\n    this.handleClick = relationship => {\n      this.editingRelationship = relationship;\n      if (this.editingConnection) {\n        this.editingConnection.selected = true;\n      }\n      this.rootStore.config.setRelationshipModalVisible(true);\n      this.rootStore.instance.selectInstanceItem(relationship.fromInstanceItem);\n    };\n    /**\n     * handle relationship right click\n     * @param relationship\n     */\n    this.handleRightClick = relationship => {\n      this.editingRelationship = relationship;\n      this.rootStore.config.setRelationshipMenuVisible(true);\n      this.rootStore.instance.selectInstanceItem(relationship.fromInstanceItem);\n    };\n    /**\n     * switch from & to for editing relationship\n     */\n    this.switch = () => {\n      if (this.editingRelationship) {\n        const storeId = this.rootStore.undo.preserve({\n          relationships: [this.editingRelationship.toJSON()]\n        });\n        this.editingRelationship.switch();\n        this.rootStore.undo.save(storeId, {\n          relationships: [this.editingRelationship.toJSON()]\n        });\n        this.deleteConnection(this.editingRelationship);\n        this.createConnection(this.editingRelationship);\n      }\n    };\n    /**\n     * update name for editing relationship\n     * @param name\n     */\n    this.updateName = name => {\n      if (this.editingRelationship) {\n        const storeId = this.rootStore.undo.preserve({\n          relationships: [this.editingRelationship.toJSON()]\n        });\n        this.editingRelationship.relationship = name;\n        this.rootStore.undo.save(storeId, {\n          relationships: [this.editingRelationship.toJSON()]\n        });\n        const cid = this.connectionMap[this.editingRelationship.id];\n        const connection = this.connections[cid];\n        if (connection) {\n          connection.name = name;\n        }\n      }\n    };\n    /**\n     * delete editing relationship\n     */\n    this.deleteFromCurrentFrame = () => {\n      this.deleteFromFrames([this.rootStore.frame.currentFrame]);\n    };\n    /**\n     * delete editing relationship from frames\n     * @param frames\n     */\n    this.deleteFromFrames = frames => {\n      if (this.editingRelationship) {\n        const storeId = this.rootStore.undo.preserve({\n          relationships: [this.editingRelationship.toJSON()]\n        });\n        const deletedFrames = this.editingRelationship.deleteFromFrames(frames);\n        if (frames.indexOf(this.rootStore.frame.currentFrame) >= 0) {\n          this.deleteConnection(this.editingRelationship);\n        }\n        if (this.editingRelationship.isEmpty) {\n          this.deleteRelationship(this.editingRelationship);\n        }\n        this.rootStore.undo.save(storeId, {\n          relationships: [this.editingRelationship.toJSON()]\n        });\n        message.success(i18n.translate('RELATIONSHIP_DELETE_MSG', {\n          values: {\n            frames: formatFrames(deletedFrames)\n          }\n        }));\n      }\n      this.finishUpdate();\n    };\n    /**\n     * copy editing relationship to next frame\n     */\n    this.copyToNextFrame = () => {\n      const {\n        currentFrame,\n        frameCount\n      } = this.rootStore.frame;\n      if (currentFrame + 1 < frameCount) {\n        this.copyToFrames([currentFrame + 1]);\n      }\n    };\n    /**\n     * copy editing relationship to frames\n     * @param frames\n     */\n    this.copyToFrames = frames => {\n      if (this.editingRelationship) {\n        const storeId = this.rootStore.undo.preserve({\n          relationships: [this.editingRelationship.toJSON()]\n        });\n        const {\n          fromInstanceItem,\n          toInstanceItem,\n          fromCamera,\n          toCamera\n        } = this.editingRelationship;\n        const fromCameraData = fromInstanceItem.getCamera(fromCamera);\n        const toCameraData = toInstanceItem.getCamera(toCamera);\n        const successFrames = [];\n        for (let i = 0; i < frames.length; i += 1) {\n          const frameIndex = frames[i];\n          if (fromCameraData.frames[frameIndex] && toCameraData.frames[frameIndex] && !this.editingRelationship.frames[frameIndex]) {\n            // exists\n            this.editingRelationship.addToFrame(frameIndex);\n            successFrames.push(frameIndex);\n          }\n        }\n        this.rootStore.undo.save(storeId, {\n          relationships: [this.editingRelationship.toJSON()]\n        });\n        if (successFrames.length > 0) {\n          message.success(i18n.translate('RELATIONSHIP_COPY_MSG', {\n            values: {\n              frames: formatFrames(successFrames)\n            }\n          }));\n        } else {\n          message.success(i18n.translate('RELATIONSHIP_COPY_MSG_SKIP'));\n        }\n      }\n      this.finishUpdate();\n    };\n    /**\n     * finish editing\n     */\n    this.finishUpdate = () => {\n      this.rootStore.config.setRelationshipModalVisible(false);\n      this.rootStore.config.setRelationshipMenuVisible(false);\n      if (this.editingConnection) {\n        this.editingConnection.selected = false;\n      }\n      this.editingRelationship = null;\n      this.menuPosition = null;\n    };\n    /**\n     * copy relationships to current frame from last frame\n     * @param instanceItem\n     */\n    this.copyFromLastFrame = instanceItem => {\n      const {\n        currentCamera,\n        currentFrame\n      } = this.rootStore.frame;\n      const lastFrame = currentFrame - 1;\n      if (lastFrame < 0) {\n        return;\n      }\n      const {\n        relationships\n      } = instanceItem.getCamera(currentCamera);\n      if (relationships.length <= 0) {\n        return;\n      }\n      let successCount = 0;\n      let skipCount = 0;\n      const prevRelationships = [];\n      const currRelationships = [];\n      const {\n        getShapeByInstanceItem\n      } = this.rootStore.shape;\n      relationships.forEach(r => {\n        const {\n          frames,\n          fromInstanceItem,\n          toInstanceItem\n        } = r;\n        if (frames[lastFrame] !== undefined && frames[currentFrame] === undefined) {\n          // exist in last frame, not in current frame\n          const relatedItem = fromInstanceItem === instanceItem ? toInstanceItem : fromInstanceItem;\n          const relatedShape = getShapeByInstanceItem(relatedItem);\n          if (relatedShape) {\n            // paste to current frame\n            prevRelationships.push(r.toJSON());\n            r.addToFrame(currentFrame);\n            currRelationships.push(r.toJSON());\n            this.createConnection(r);\n            successCount += 1;\n          } else {\n            skipCount += 1;\n          }\n        }\n      });\n      this.rootStore.undo.push({\n        relationships: prevRelationships\n      }, {\n        relationships: currRelationships\n      });\n      let msg = '';\n      if (successCount > 0) {\n        msg = i18n.translate('RELATIONSHIP_LAST_FRAME_COPY_MSG_SUCCESS', {\n          values: {\n            count: successCount\n          }\n        });\n        if (skipCount > 0) {\n          msg = `${msg}; `;\n        }\n      }\n      if (skipCount > 0) {\n        msg = `${msg}${i18n.translate('RELATIONSHIP_LAST_FRAME_COPY_MSG_SKIP', {\n          values: {\n            count: skipCount\n          }\n        })}`;\n      }\n      message.success(msg);\n    };\n    /**\n     * open menu by relationship\n     * @param relationship\n     */\n    this.openMenuByRelationship = (relationship, e) => {\n      this.editingRelationship = relationship;\n      this.rootStore.config.setRelationshipMenuVisible(true);\n      const bbox = e.target.getBoundingClientRect();\n      this.menuPosition = {\n        x: bbox.left,\n        y: bbox.bottom\n      };\n    };\n    /**\n     * delete from frames by instance item\n     * @param instanceItem\n     * @param camera\n     * @param frames\n     */\n    this.deleteFromFramesByInstanceItem = (instanceItem, camera, frames) => {\n      const {\n        currentFrame\n      } = this.rootStore.frame;\n      const currentFrameIncluded = frames.indexOf(currentFrame) >= 0;\n      const {\n        relationships\n      } = instanceItem.getCamera(camera);\n      const prevRelationships = [];\n      const currRelationships = [];\n      [...relationships].forEach(r => {\n        prevRelationships.push(r.toJSON());\n        r.deleteFromFrames(frames);\n        if (currentFrameIncluded) {\n          this.deleteConnection(r);\n        }\n        if (r.isEmpty) {\n          this.deleteRelationship(r);\n        } else {\n          currRelationships.push(r.toJSON());\n        }\n      });\n      return {\n        prevRelationships,\n        currRelationships\n      };\n    };\n    /**\n     * update connections interactive\n     * @param interactive\n     */\n    this.updateConnectionsInteractive = interactive => {\n      Object.values(this.connections).forEach(c => {\n        c.interactive = interactive;\n      });\n    };\n    /**\n     * update connection visible\n     * @param visible\n     */\n    this.updateConnectionsVisible = visible => {\n      Object.values(this.connections).forEach(c => {\n        c.visible = visible;\n      });\n    };\n    /**\n     * on shape hovered, update connections visibility\n     * @param shapeId\n     */\n    this.onShapeHovered = shapeId => {\n      const {\n        activeRelationshipsMode\n      } = this.rootStore.config;\n      if (activeRelationshipsMode === AttributesMode.HOVER) {\n        this.updateConnectionsVisible(false);\n        const {\n          instanceItem\n        } = this.rootStore.shape.shapes[shapeId] || {};\n        if (instanceItem) {\n          const {\n            relationships\n          } = instanceItem.getCamera(this.rootStore.frame.currentCamera);\n          relationships.forEach(r => {\n            const cid = this.connectionMap[r.id];\n            const connection = this.connections[cid];\n            if (connection && this.visibleConnectionIds.indexOf(cid) >= 0) {\n              connection.visible = true;\n            }\n          });\n        }\n      }\n    };\n    makeAutoObservable(this, {\n      rootStore: false,\n      relationships: false,\n      fromIcon: false,\n      currentConnection: false,\n      connections: false\n    }, {\n      autoBind: true\n    });\n    this.rootStore = rootStore;\n  }\n\n  /**\n   * get exist relationship\n   * @param fromInstanceItem\n   * @param toInstanceItem\n   * @param fromCamera\n   * @param toCamera\n   * @param relationship\n   */\n  getRelationship(fromInstanceItem, toInstanceItem, fromCamera, toCamera, relationship) {\n    return this.relationships.find(r => r.fromInstanceItem === fromInstanceItem && r.toInstanceItem === toInstanceItem && r.fromCamera === fromCamera && r.toCamera === toCamera && r.relationship === relationship);\n  }\n\n  /**\n   * init relationship settings\n   * @param payload\n   */\n  init(payload) {\n    const {\n      relationships\n    } = payload;\n    if (typeof relationships === 'string') {\n      const arr = relationships.split(',').map(i => i.trim()).filter(i => !!i);\n      this.options = arr.map(i => ({\n        name: i\n      }));\n    }\n  }\n\n  /**\n   * init relationships data\n   * @param relationships\n   */\n  initRelationships(relationships) {\n    this.clearRelationships();\n    if (Array.isArray(relationships)) {\n      relationships.forEach(({\n        id,\n        from = {},\n        to = {},\n        relationship,\n        frames = []\n      }) => {\n        if (from.instance && from.child && from.camera && to.instance && to.child && to.camera && relationship && this.options.findIndex(o => o.name === relationship) >= 0 && frames.length > 0 && frames.every(f => f.frameIndex !== undefined)) {\n          this.createRelationship({\n            id,\n            from,\n            to,\n            relationship,\n            frames\n          });\n        }\n      });\n    }\n  }\n  clearRelationships() {\n    this.clearConnections();\n    this.relationships = [];\n  }\n\n  /**\n   * setup connections\n   */\n  setupConnections() {\n    this.clearConnections();\n    const {\n      currentFrame\n    } = this.rootStore.frame;\n    this.relationships.forEach(relationship => {\n      if (relationship.frames[currentFrame]) {\n        this.createConnection(relationship);\n      }\n    });\n    this.hideOrShowRelationships();\n  }\n\n  /**\n   * clear all connections\n   */\n  clearConnections() {\n    Object.values(this.connections).forEach(c => c.remove());\n    this.connectionMap = {};\n    this.visibleConnectionIds = [];\n  }\n\n  /**\n   * set active option index\n   * @param optionIndex\n   */\n  setActiveOption(optionIndex) {\n    this.activeOptionIndex = optionIndex;\n  }\n\n  /**\n   * activate set relationship\n   */\n  activate() {\n    if (this.rootStore.instance.isSingleSelected) {\n      this.fromInstanceItem = this.rootStore.instance.selectedInstanceItems[0];\n      const icon = this.addIcon(this.fromInstanceItem, this.rootStore.frame.currentCamera);\n      if (icon) {\n        this.rootStore.segmentation.cancelUpdate();\n        this.rootStore.segmentation.cancelSwitch();\n        this.fromIcon = icon;\n        document.addEventListener('mousemove', this.handleMouseMove);\n      }\n    }\n  }\n\n  /**\n   * cancel set relationship\n   */\n  cancel() {\n    var _this$currentConnecti;\n    if (this.fromInstanceItem) {\n      const {\n        currentCamera,\n        currentFrame\n      } = this.rootStore.frame;\n      const fromRelationships = this.fromInstanceItem.getCamera(currentCamera).relationships.filter(({\n        frames\n      }) => !!frames[currentFrame]);\n      if (fromRelationships.length === 0) {\n        var _this$fromIcon;\n        (_this$fromIcon = this.fromIcon) === null || _this$fromIcon === void 0 ? void 0 : _this$fromIcon.remove();\n      }\n    }\n    this.fromInstanceItem = null;\n    this.fromIcon = null;\n    (_this$currentConnecti = this.currentConnection) === null || _this$currentConnecti === void 0 ? void 0 : _this$currentConnecti.remove();\n    this.currentConnection = null;\n    document.removeEventListener('mousemove', this.handleMouseMove);\n  }\n\n  /**\n   * add relationship\n   * @param toInstanceItem\n   */\n  add(toInstanceItem) {\n    if (!this.fromInstanceItem) {\n      return;\n    }\n    const {\n      currentCamera,\n      currentFrame\n    } = this.rootStore.frame;\n    const activeRelationship = this.options[this.activeOptionIndex].name;\n    const existRelationship = this.getRelationship(this.fromInstanceItem, toInstanceItem, currentCamera, currentCamera, activeRelationship);\n    const storeId = this.rootStore.undo.preserve({\n      relationships: existRelationship ? [existRelationship.toJSON()] : []\n    });\n    if (existRelationship) {\n      if (!existRelationship.frames[currentFrame]) {\n        existRelationship.addToFrame(currentFrame);\n        this.rootStore.undo.save(storeId, {\n          relationships: [existRelationship.toJSON()]\n        });\n      }\n      this.deleteConnection(existRelationship);\n      this.createConnection(existRelationship, true);\n    } else {\n      const relationship = new Relationship({\n        fromInstanceItem: this.fromInstanceItem,\n        toInstanceItem,\n        fromCamera: currentCamera,\n        toCamera: currentCamera,\n        relationship: activeRelationship,\n        frames: [{\n          frameIndex: currentFrame\n        }]\n      });\n      this.saveRelationship(relationship);\n      this.createConnection(relationship, true);\n      this.rootStore.undo.save(storeId, {\n        relationships: [relationship.toJSON()]\n      });\n    }\n    this.cancel();\n  }\n\n  /**\n   * create relationship instance\n   * @param relationship\n   */\n  createRelationship({\n    id,\n    from,\n    to,\n    relationship,\n    frames\n  }) {\n    const fromInstance = this.rootStore.instance.getInstanceById(from.instance);\n    const toInstance = this.rootStore.instance.getInstanceById(to.instance);\n    if (fromInstance && toInstance) {\n      const fromInstanceItem = fromInstance.items[from.child];\n      const toInstanceItem = toInstance.items[to.child];\n      if (fromInstanceItem && toInstanceItem) {\n        this.saveRelationship(new Relationship({\n          id,\n          fromInstanceItem,\n          toInstanceItem,\n          fromCamera: from.camera,\n          toCamera: to.camera,\n          relationship,\n          frames\n        }));\n      }\n    }\n  }\n\n  /**\n   * save relationship\n   * @param relationship\n   */\n  saveRelationship(relationship) {\n    const {\n      fromInstanceItem,\n      toInstanceItem,\n      fromCamera,\n      toCamera\n    } = relationship;\n    this.relationships.push(relationship);\n    fromInstanceItem.addRelationship(fromCamera, relationship);\n    toInstanceItem.addRelationship(toCamera, relationship);\n  }\n\n  /**\n   * delete relationship\n   * @param relationship\n   */\n  deleteRelationship(relationship) {\n    const {\n      id,\n      fromInstanceItem,\n      toInstanceItem,\n      fromCamera,\n      toCamera\n    } = relationship;\n    const index = this.relationships.findIndex(r => r.id === id);\n    if (index >= 0) {\n      this.relationships.splice(index, 1);\n    }\n    fromInstanceItem.removeRelationship(fromCamera, relationship);\n    toInstanceItem.removeRelationship(toCamera, relationship);\n  }\n\n  /**\n   * create connection\n   * @param relationship\n   * @param byMouse\n   */\n  createConnection(relationship, byMouse = false) {\n    if (!relationship.frames[this.rootStore.frame.currentFrame]) {\n      return;\n    }\n    const {\n      fromInstanceItem,\n      toInstanceItem,\n      fromCamera,\n      toCamera\n    } = relationship;\n    const fromIcon = this.addIcon(fromInstanceItem, fromCamera);\n    const toIcon = this.addIcon(toInstanceItem, toCamera);\n    if (fromIcon && toIcon) {\n      const fromRect = fromIcon.getBoundingClientRect();\n      const toRect = toIcon.getBoundingClientRect();\n      const from = {\n        x: fromRect.x + fromRect.width,\n        y: fromRect.y + fromRect.height / 2\n      };\n      const to = {\n        x: toRect.x + toRect.width / 2,\n        y: toRect.y\n      };\n      const {\n        activeRelationshipsMode\n      } = this.rootStore.config;\n      let visible = activeRelationshipsMode === AttributesMode.ALWAYS;\n      if (byMouse && activeRelationshipsMode === AttributesMode.HOVER) {\n        const {\n          hoveredShapeId,\n          shapes\n        } = this.rootStore.shape;\n        const {\n          instanceItem\n        } = shapes[hoveredShapeId] || {};\n        if (instanceItem === relationship.toInstanceItem) {\n          visible = true;\n        }\n      }\n      const connection = new Connection({\n        containerId: `${CAMERA_VIEW_CONNECTIONS}-${fromCamera}`,\n        from,\n        to,\n        text: relationship.relationship,\n        interactive: !this.rootStore.readonly,\n        visible,\n        onClick: () => this.handleClick(relationship),\n        onRightClick: () => this.handleRightClick(relationship)\n      });\n      this.connections[connection.id] = connection;\n      this.connectionMap[relationship.id] = connection.id;\n    }\n  }\n\n  /**\n   * update connection position\n   * @param instanceItem\n   * @param camera\n   * @param icon\n   */\n  updateConnection(instanceItem, camera, icon) {\n    const {\n      x,\n      y,\n      width,\n      height\n    } = icon.getBoundingClientRect();\n    const {\n      relationships\n    } = instanceItem.getCamera(camera);\n    relationships.forEach(r => {\n      const cid = this.connectionMap[r.id];\n      const connection = this.connections[cid];\n      if (connection) {\n        if (r.fromInstanceItem === instanceItem) {\n          connection.from = {\n            x: x + width,\n            y: y + height / 2\n          };\n        } else {\n          connection.to = {\n            x: x + width / 2,\n            y\n          };\n        }\n      }\n    });\n    if (this.currentConnection && this.fromInstanceItem === instanceItem) {\n      this.currentConnection.from = {\n        x: x + width,\n        y: y + height / 2\n      };\n    }\n  }\n\n  /**\n   * delete connection\n   * @param relationship\n   */\n  deleteConnection(relationship) {\n    const {\n      id,\n      fromInstanceItem,\n      toInstanceItem,\n      fromCamera,\n      toCamera\n    } = relationship;\n    // delete connection instance\n    const cid = this.connectionMap[id];\n    const connection = this.connections[cid];\n    if (connection) {\n      connection.remove();\n      delete this.connections[cid];\n    }\n    // remove mapping\n    delete this.connectionMap[id];\n    // remove icon\n    const {\n      currentFrame\n    } = this.rootStore.frame;\n    const fromRelationships = fromInstanceItem.getCamera(fromCamera).relationships.filter(({\n      frames\n    }) => !!frames[currentFrame]);\n    if (fromRelationships.length === 0) {\n      this.removeIcon(fromInstanceItem);\n    }\n    const toRelationships = toInstanceItem.getCamera(toCamera).relationships.filter(({\n      frames\n    }) => !!frames[currentFrame]);\n    if (toRelationships.length === 0) {\n      this.removeIcon(toInstanceItem);\n    }\n  }\n\n  /**\n   * add icon to shape\n   * @param instanceItem\n   * @param camera\n   */\n  addIcon(instanceItem, camera) {\n    const shape = this.rootStore.shape.getShapeByInstanceItem(instanceItem, camera);\n    if (shape && shape.labelDom) {\n      // add relationship icon\n      const icon = document.createElement('div');\n      icon.className = 'relationship-icon';\n      icon.innerHTML = `\n        <svg width=\"1em\" height=\"1em\" viewBox=\"0 0 12 12\" version=\"1.1\">\n          <g stroke=\"none\" strokeWidth=\"1\" fill=\"none\" fillRule=\"evenodd\" transform=\"translate(-228.000000, -509.000000)\">\n            <g transform=\"translate(226.575379, 507.575379)\">\n              <path d=\"M5.9246212,3.9246212 L5.9246212,4.9246212 L3.9246212,4.9246212 C2.54390933,4.9246212 1.4246212,6.04390933 1.4246212,7.4246212 C1.4246212,8.7501046 2.45615714,9.83465987 3.76024551,9.91930352 L3.9246212,9.9246212 L5.9246212,9.9246212 L5.9246212,10.9246212 L3.9246212,10.9246212 C1.99162458,10.9246212 0.424621202,9.35761783 0.424621202,7.4246212 C0.424621202,5.5560578 1.8888988,4.02949475 3.732586,3.92980007 L3.9246212,3.9246212 L5.9246212,3.9246212 Z M10.9246212,3.9246212 C12.8576178,3.9246212 14.4246212,5.49162458 14.4246212,7.4246212 C14.4246212,9.29318461 12.9603436,10.8197477 11.1166564,10.9194423 L10.9246212,10.9246212 L8.9246212,10.9246212 L8.9246212,9.9246212 L10.9246212,9.9246212 C12.3053331,9.9246212 13.4246212,8.80533308 13.4246212,7.4246212 C13.4246212,6.0991378 12.3930853,5.01458253 11.0889969,4.92993888 L10.9246212,4.9246212 L8.9246212,4.9246212 L8.9246212,3.9246212 L10.9246212,3.9246212 Z M9.4246212,6.9246212 L9.4246212,7.9246212 L5.4246212,7.9246212 L5.4246212,6.9246212 L9.4246212,6.9246212 Z\" fill=\"currentColor\" fillRule=\"nonzero\" transform=\"translate(7.424621, 7.424621) rotate(-315.000000) translate(-7.424621, -7.424621) \" />\n            </g>\n          </g>\n        </svg>\n      `;\n      shape.labelDom.setSuffix(icon);\n      shape.labelDom.onPositionChange = () => this.updateConnection(instanceItem, camera, icon);\n      return icon;\n    }\n    return null;\n  }\n\n  /**\n   * remove icon from shape\n   * @param instanceItem\n   */\n  removeIcon(instanceItem) {\n    const shape = this.rootStore.shape.getShapeByInstanceItem(instanceItem);\n    if (shape && shape.labelDom) {\n      shape.labelDom.setSuffix();\n    }\n  }\n  /**\n   * setup relationships for instance item\n   * @param instanceItem\n   * @param camera\n   */\n  setupRelationshipsForInstanceItem(instanceItem, camera) {\n    this.relationships.forEach(r => {\n      const {\n        fromInstanceItem,\n        toInstanceItem,\n        fromCamera,\n        toCamera\n      } = r;\n      if (fromInstanceItem.id === instanceItem.id) {\n        if (!camera) {\n          instanceItem.removeRelationship(fromCamera, r);\n          instanceItem.addRelationship(fromCamera, r);\n        } else if (camera === fromCamera) {\n          instanceItem.removeRelationship(camera, r);\n          instanceItem.addRelationship(camera, r);\n        }\n        r.fromInstanceItem = instanceItem;\n      } else if (toInstanceItem.id === instanceItem.id) {\n        if (!camera) {\n          instanceItem.removeRelationship(toCamera, r);\n          instanceItem.addRelationship(toCamera, r);\n        } else if (camera === toCamera) {\n          instanceItem.removeRelationship(camera, r);\n          instanceItem.addRelationship(camera, r);\n        }\n        r.toInstanceItem = instanceItem;\n      }\n    });\n  }\n\n  /**\n   * setup connections for instance item\n   * @param instanceItem\n   */\n  setupConnectionsForInstanceItem(instanceItem) {\n    const {\n      currentCamera,\n      currentFrame\n    } = this.rootStore.frame;\n    const {\n      relationships\n    } = instanceItem.getCamera(currentCamera);\n    relationships.forEach(r => {\n      if (r.frames[currentFrame]) {\n        this.deleteConnection(r);\n        this.createConnection(r);\n      }\n    });\n  }\n  /**\n   * hide or show relationships by visible instance items\n   */\n  hideOrShowRelationships() {\n    const {\n      activeRelationshipsMode\n    } = this.rootStore.config;\n    const {\n      shapes,\n      visibleShapeIds\n    } = this.rootStore.shape;\n    const visibleConnectionIds = new Set();\n    visibleShapeIds.forEach(sid => {\n      const shapeInfo = shapes[sid];\n      if (shapeInfo) {\n        const {\n          instanceItem\n        } = shapeInfo;\n        Object.values(instanceItem.cameras).forEach(({\n          relationships\n        }) => {\n          relationships.forEach(relationship => {\n            const {\n              id,\n              fromInstanceItem,\n              toInstanceItem\n            } = relationship;\n            const cid = this.connectionMap[id];\n            const connection = this.connections[cid];\n            if (connection) {\n              const otherInstanceItem = instanceItem === fromInstanceItem ? toInstanceItem : fromInstanceItem;\n              if (visibleShapeIds.findIndex(oid => {\n                var _shapes$oid;\n                return ((_shapes$oid = shapes[oid]) === null || _shapes$oid === void 0 ? void 0 : _shapes$oid.instanceItem.id) === otherInstanceItem.id;\n              }) >= 0) {\n                visibleConnectionIds.add(cid);\n              }\n            }\n          });\n        });\n      }\n    });\n    this.visibleConnectionIds = Array.from(visibleConnectionIds);\n    Object.values(this.connections).forEach(connection => {\n      if (visibleConnectionIds.has(connection.id)) {\n        connection.visible = activeRelationshipsMode === AttributesMode.ALWAYS;\n      } else {\n        connection.visible = false;\n      }\n    });\n  }\n\n  /**\n   * get relationships json data (for save)\n   */\n  relationshipsJSON() {\n    return this.relationships.map(r => r.toJSON());\n  }\n}","map":{"version":3,"names":["makeAutoObservable","message","AttributesMode","Relationship","Connection","i18n","CAMERA_VIEW_CONNECTIONS","formatFrames","RelationshipStore","relationshipEnabled","options","length","settingRelationship","fromInstanceItem","editingConnection","editingRelationship","undefined","cid","connectionMap","id","connections","constructor","rootStore","activeOptionIndex","relationships","menuPosition","fromIcon","currentConnection","visibleConnectionIds","handleMouseMove","event","to","x","clientX","y","clientY","fromRect","getBoundingClientRect","from","width","height","containerId","frame","currentCamera","text","name","handleClick","relationship","selected","config","setRelationshipModalVisible","instance","selectInstanceItem","handleRightClick","setRelationshipMenuVisible","switch","storeId","undo","preserve","toJSON","save","deleteConnection","createConnection","updateName","connection","deleteFromCurrentFrame","deleteFromFrames","currentFrame","frames","deletedFrames","indexOf","isEmpty","deleteRelationship","success","translate","values","finishUpdate","copyToNextFrame","frameCount","copyToFrames","toInstanceItem","fromCamera","toCamera","fromCameraData","getCamera","toCameraData","successFrames","i","frameIndex","addToFrame","push","copyFromLastFrame","instanceItem","lastFrame","successCount","skipCount","prevRelationships","currRelationships","getShapeByInstanceItem","shape","forEach","r","relatedItem","relatedShape","msg","count","openMenuByRelationship","e","bbox","target","left","bottom","deleteFromFramesByInstanceItem","camera","currentFrameIncluded","updateConnectionsInteractive","interactive","Object","c","updateConnectionsVisible","visible","onShapeHovered","shapeId","activeRelationshipsMode","HOVER","shapes","autoBind","getRelationship","find","init","payload","arr","split","map","trim","filter","initRelationships","clearRelationships","Array","isArray","child","findIndex","o","every","f","createRelationship","clearConnections","setupConnections","hideOrShowRelationships","remove","setActiveOption","optionIndex","activate","isSingleSelected","selectedInstanceItems","icon","addIcon","segmentation","cancelUpdate","cancelSwitch","document","addEventListener","cancel","_this$currentConnecti","fromRelationships","_this$fromIcon","removeEventListener","add","activeRelationship","existRelationship","saveRelationship","fromInstance","getInstanceById","toInstance","items","addRelationship","index","splice","removeRelationship","byMouse","toIcon","toRect","ALWAYS","hoveredShapeId","readonly","onClick","onRightClick","updateConnection","removeIcon","toRelationships","labelDom","createElement","className","innerHTML","setSuffix","onPositionChange","setupRelationshipsForInstanceItem","setupConnectionsForInstanceItem","visibleShapeIds","Set","sid","shapeInfo","cameras","otherInstanceItem","oid","_shapes$oid","has","relationshipsJSON"],"sources":["/Users/qzheng/Documents/webroot/annotation_tools/src/components/video-tracking2/store/RelationshipStore.ts"],"sourcesContent":["import { makeAutoObservable } from 'mobx';\nimport { message } from 'antd';\nimport RootStore from './RootStore';\nimport { Payload, RelationshipOption, Relationship as IRelationship, AttributesMode } from '../types';\nimport Relationship from '../model/Relationship';\nimport InstanceItem from '../model/InstanceItem';\nimport Connection from '../view/Connection';\nimport i18n from '../locales';\nimport { CAMERA_VIEW_CONNECTIONS } from '../constants';\nimport { formatFrames } from '../utils';\n\nexport default class RelationshipStore {\n  /**\n   * root store\n   */\n  rootStore: typeof RootStore;\n\n  /**\n   * relationship options\n   */\n  options: RelationshipOption[] = [];\n\n  /**\n   * active option index\n   */\n  activeOptionIndex = 0;\n\n  /**\n   * saved relationships\n   */\n  relationships: Relationship[] = [];\n\n  /**\n   * editing relationship\n   */\n  editingRelationship: Relationship | null = null;\n\n  /**\n   * relationship menu position\n   */\n  menuPosition: { x: number; y: number } | null = null;\n\n  /**\n   * from instance item current editing\n   */\n  fromInstanceItem: InstanceItem | null = null;\n\n  /**\n   * from instance item relationship icon\n   */\n  fromIcon: HTMLDivElement | null = null;\n\n  /**\n   * current editing connection\n   */\n  currentConnection: Connection | null = null;\n\n  /**\n   * all onnection instances in current frame & current camera\n   */\n  connections: {\n    [id: string]: Connection;\n  } = {};\n\n  /**\n   * relationship id & connection id mapping\n   */\n  connectionMap: {\n    [relationshipId: string]: string;\n  } = {};\n\n  /**\n   * visible connection ids\n   */\n  visibleConnectionIds: string[] = [];\n\n  /**\n   * is relationship enabled\n   * @getter\n   */\n  get relationshipEnabled() {\n    return this.options.length > 0;\n  }\n\n  /**\n   * is setting relationship\n   * @getter\n   */\n  get settingRelationship() {\n    return this.fromInstanceItem !== null;\n  }\n\n  /**\n   * editing connection\n   * @getter\n   */\n  get editingConnection() {\n    if (!this.editingRelationship) {\n      return undefined;\n    }\n    const cid = this.connectionMap[this.editingRelationship.id];\n    return this.connections[cid];\n  }\n\n  constructor(rootStore: typeof RootStore) {\n    makeAutoObservable(this, {\n      rootStore: false,\n      relationships: false,\n      fromIcon: false,\n      currentConnection: false,\n      connections: false,\n    }, {\n      autoBind: true,\n    });\n\n    this.rootStore = rootStore;\n  }\n\n  /**\n   * get exist relationship\n   * @param fromInstanceItem\n   * @param toInstanceItem\n   * @param fromCamera\n   * @param toCamera\n   * @param relationship\n   */\n  getRelationship(fromInstanceItem: InstanceItem, toInstanceItem: InstanceItem, fromCamera: string, toCamera: string, relationship: string) {\n    return this.relationships.find((r) => (\n      r.fromInstanceItem === fromInstanceItem &&\n      r.toInstanceItem === toInstanceItem &&\n      r.fromCamera === fromCamera &&\n      r.toCamera === toCamera &&\n      r.relationship === relationship\n    ));\n  }\n\n  /**\n   * init relationship settings\n   * @param payload\n   */\n  init(payload: Payload) {\n    const { relationships } = payload;\n    if (typeof relationships === 'string') {\n      const arr = relationships.split(',').map((i) => i.trim()).filter((i) => !!i);\n      this.options = arr.map((i) => ({ name: i }));\n    }\n  }\n\n  /**\n   * init relationships data\n   * @param relationships\n   */\n  initRelationships(relationships: any) {\n    this.clearRelationships();\n    if (Array.isArray(relationships)) {\n      relationships.forEach(({ id, from = {}, to = {}, relationship, frames = [] }) => {\n        if (\n          from.instance && from.child && from.camera &&\n          to.instance && to.child && to.camera &&\n          relationship && this.options.findIndex((o) => o.name === relationship) >= 0 &&\n          frames.length > 0 && frames.every((f: any) => f.frameIndex !== undefined)\n        ) {\n          this.createRelationship({ id, from, to, relationship, frames });\n        }\n      });\n    }\n  }\n\n  clearRelationships() {\n    this.clearConnections();\n    this.relationships = [];\n  }\n\n  /**\n   * setup connections\n   */\n  setupConnections() {\n    this.clearConnections();\n    const { currentFrame } = this.rootStore.frame;\n    this.relationships.forEach((relationship) => {\n      if (relationship.frames[currentFrame]) {\n        this.createConnection(relationship);\n      }\n    });\n    this.hideOrShowRelationships();\n  }\n\n  /**\n   * clear all connections\n   */\n  clearConnections() {\n    Object.values(this.connections).forEach((c) => c.remove());\n    this.connectionMap = {};\n    this.visibleConnectionIds = [];\n  }\n\n  /**\n   * set active option index\n   * @param optionIndex\n   */\n  setActiveOption(optionIndex: number) {\n    this.activeOptionIndex = optionIndex;\n  }\n\n  /**\n   * activate set relationship\n   */\n  activate() {\n    if (this.rootStore.instance.isSingleSelected) {\n      this.fromInstanceItem = this.rootStore.instance.selectedInstanceItems[0];\n      const icon = this.addIcon(this.fromInstanceItem, this.rootStore.frame.currentCamera);\n      if (icon) {\n        this.rootStore.segmentation.cancelUpdate();\n        this.rootStore.segmentation.cancelSwitch();\n        this.fromIcon = icon;\n        document.addEventListener('mousemove', this.handleMouseMove);\n      }\n    }\n  }\n\n  /**\n   * cancel set relationship\n   */\n  cancel() {\n    if (this.fromInstanceItem) {\n      const { currentCamera, currentFrame } = this.rootStore.frame;\n      const fromRelationships = this.fromInstanceItem.getCamera(currentCamera).relationships.filter(({ frames }) => !!frames[currentFrame]);\n      if (fromRelationships.length === 0) {\n        this.fromIcon?.remove();\n      }\n    }\n    this.fromInstanceItem = null;\n    this.fromIcon = null;\n    this.currentConnection?.remove();\n    this.currentConnection = null;\n    document.removeEventListener('mousemove', this.handleMouseMove);\n  }\n\n  /**\n   * add relationship\n   * @param toInstanceItem\n   */\n  add(toInstanceItem: InstanceItem) {\n    if (!this.fromInstanceItem) {\n      return;\n    }\n\n    const { currentCamera, currentFrame } = this.rootStore.frame;\n    const activeRelationship = this.options[this.activeOptionIndex].name;\n    const existRelationship = this.getRelationship(this.fromInstanceItem, toInstanceItem, currentCamera, currentCamera, activeRelationship);\n    const storeId = this.rootStore.undo.preserve({\n      relationships: existRelationship ? [existRelationship.toJSON()] : [],\n    });\n    if (existRelationship) {\n      if (!existRelationship.frames[currentFrame]) {\n        existRelationship.addToFrame(currentFrame);\n        this.rootStore.undo.save(storeId, {\n          relationships: [existRelationship.toJSON()],\n        });\n      }\n      this.deleteConnection(existRelationship);\n      this.createConnection(existRelationship, true);\n    } else {\n      const relationship = new Relationship({\n        fromInstanceItem: this.fromInstanceItem,\n        toInstanceItem,\n        fromCamera: currentCamera,\n        toCamera: currentCamera,\n        relationship: activeRelationship,\n        frames: [{\n          frameIndex: currentFrame,\n        }],\n      });\n      this.saveRelationship(relationship);\n      this.createConnection(relationship, true);\n      this.rootStore.undo.save(storeId, {\n        relationships: [relationship.toJSON()],\n      });\n    }\n    this.cancel();\n  }\n\n  /**\n   * create relationship instance\n   * @param relationship\n   */\n  createRelationship({ id, from, to, relationship, frames }: IRelationship) {\n    const fromInstance = this.rootStore.instance.getInstanceById(from.instance);\n    const toInstance = this.rootStore.instance.getInstanceById(to.instance);\n    if (fromInstance && toInstance) {\n      const fromInstanceItem = fromInstance.items[from.child];\n      const toInstanceItem = toInstance.items[to.child];\n      if (fromInstanceItem && toInstanceItem) {\n        this.saveRelationship(new Relationship({\n          id,\n          fromInstanceItem,\n          toInstanceItem,\n          fromCamera: from.camera,\n          toCamera: to.camera,\n          relationship,\n          frames,\n        }));\n      }\n    }\n  }\n\n  /**\n   * save relationship\n   * @param relationship\n   */\n  saveRelationship(relationship: Relationship) {\n    const { fromInstanceItem, toInstanceItem, fromCamera, toCamera } = relationship;\n    this.relationships.push(relationship);\n    fromInstanceItem.addRelationship(fromCamera, relationship);\n    toInstanceItem.addRelationship(toCamera, relationship);\n  }\n\n  /**\n   * delete relationship\n   * @param relationship\n   */\n  deleteRelationship(relationship: Relationship) {\n    const { id, fromInstanceItem, toInstanceItem, fromCamera, toCamera } = relationship;\n    const index = this.relationships.findIndex((r) => r.id === id);\n    if (index >= 0) {\n      this.relationships.splice(index, 1);\n    }\n    fromInstanceItem.removeRelationship(fromCamera, relationship);\n    toInstanceItem.removeRelationship(toCamera, relationship);\n  }\n\n  /**\n   * create connection\n   * @param relationship\n   * @param byMouse\n   */\n  createConnection(relationship: Relationship, byMouse = false) {\n    if (!relationship.frames[this.rootStore.frame.currentFrame]) {\n      return;\n    }\n    const { fromInstanceItem, toInstanceItem, fromCamera, toCamera } = relationship;\n    const fromIcon = this.addIcon(fromInstanceItem, fromCamera);\n    const toIcon = this.addIcon(toInstanceItem, toCamera);\n    if (fromIcon && toIcon) {\n      const fromRect = fromIcon.getBoundingClientRect();\n      const toRect = toIcon.getBoundingClientRect();\n      const from = {\n        x: fromRect.x + fromRect.width,\n        y: fromRect.y + fromRect.height / 2,\n      };\n      const to = {\n        x: toRect.x + toRect.width / 2,\n        y: toRect.y,\n      };\n      const { activeRelationshipsMode } = this.rootStore.config;\n      let visible = activeRelationshipsMode === AttributesMode.ALWAYS;\n      if (byMouse && activeRelationshipsMode === AttributesMode.HOVER) {\n        const { hoveredShapeId, shapes } = this.rootStore.shape;\n        const { instanceItem } = shapes[hoveredShapeId] || {};\n        if (instanceItem === relationship.toInstanceItem) {\n          visible = true;\n        }\n      }\n      const connection = new Connection({\n        containerId: `${CAMERA_VIEW_CONNECTIONS}-${fromCamera}`,\n        from,\n        to,\n        text: relationship.relationship,\n        interactive: !this.rootStore.readonly,\n        visible,\n        onClick: () => this.handleClick(relationship),\n        onRightClick: () => this.handleRightClick(relationship),\n      });\n      this.connections[connection.id] = connection;\n      this.connectionMap[relationship.id] = connection.id;\n    }\n  }\n\n  /**\n   * update connection position\n   * @param instanceItem\n   * @param camera\n   * @param icon\n   */\n  updateConnection(instanceItem: InstanceItem, camera: string, icon: HTMLDivElement) {\n    const { x, y, width, height } = icon.getBoundingClientRect();\n    const { relationships } = instanceItem.getCamera(camera);\n    relationships.forEach((r) => {\n      const cid = this.connectionMap[r.id];\n      const connection = this.connections[cid];\n      if (connection) {\n        if (r.fromInstanceItem === instanceItem) {\n          connection.from = {\n            x: x + width,\n            y: y + height / 2,\n          };\n        } else {\n          connection.to = {\n            x: x + width / 2,\n            y,\n          };\n        }\n      }\n    });\n    if (this.currentConnection && this.fromInstanceItem === instanceItem) {\n      this.currentConnection.from = {\n        x: x + width,\n        y: y + height / 2,\n      };\n    }\n  }\n\n  /**\n   * delete connection\n   * @param relationship\n   */\n  deleteConnection(relationship: Relationship) {\n    const { id, fromInstanceItem, toInstanceItem, fromCamera, toCamera } = relationship;\n    // delete connection instance\n    const cid = this.connectionMap[id];\n    const connection = this.connections[cid];\n    if (connection) {\n      connection.remove();\n      delete this.connections[cid];\n    }\n    // remove mapping\n    delete this.connectionMap[id];\n    // remove icon\n    const { currentFrame } = this.rootStore.frame;\n    const fromRelationships = fromInstanceItem.getCamera(fromCamera).relationships.filter(({ frames }) => !!frames[currentFrame]);\n    if (fromRelationships.length === 0) {\n      this.removeIcon(fromInstanceItem);\n    }\n    const toRelationships = toInstanceItem.getCamera(toCamera).relationships.filter(({ frames }) => !!frames[currentFrame]);\n    if (toRelationships.length === 0) {\n      this.removeIcon(toInstanceItem);\n    }\n  }\n\n  /**\n   * add icon to shape\n   * @param instanceItem\n   * @param camera\n   */\n  addIcon(instanceItem: InstanceItem, camera: string) {\n    const shape = this.rootStore.shape.getShapeByInstanceItem(instanceItem, camera);\n    if (shape && shape.labelDom) {\n      // add relationship icon\n      const icon = document.createElement('div');\n      icon.className = 'relationship-icon';\n      icon.innerHTML = `\n        <svg width=\"1em\" height=\"1em\" viewBox=\"0 0 12 12\" version=\"1.1\">\n          <g stroke=\"none\" strokeWidth=\"1\" fill=\"none\" fillRule=\"evenodd\" transform=\"translate(-228.000000, -509.000000)\">\n            <g transform=\"translate(226.575379, 507.575379)\">\n              <path d=\"M5.9246212,3.9246212 L5.9246212,4.9246212 L3.9246212,4.9246212 C2.54390933,4.9246212 1.4246212,6.04390933 1.4246212,7.4246212 C1.4246212,8.7501046 2.45615714,9.83465987 3.76024551,9.91930352 L3.9246212,9.9246212 L5.9246212,9.9246212 L5.9246212,10.9246212 L3.9246212,10.9246212 C1.99162458,10.9246212 0.424621202,9.35761783 0.424621202,7.4246212 C0.424621202,5.5560578 1.8888988,4.02949475 3.732586,3.92980007 L3.9246212,3.9246212 L5.9246212,3.9246212 Z M10.9246212,3.9246212 C12.8576178,3.9246212 14.4246212,5.49162458 14.4246212,7.4246212 C14.4246212,9.29318461 12.9603436,10.8197477 11.1166564,10.9194423 L10.9246212,10.9246212 L8.9246212,10.9246212 L8.9246212,9.9246212 L10.9246212,9.9246212 C12.3053331,9.9246212 13.4246212,8.80533308 13.4246212,7.4246212 C13.4246212,6.0991378 12.3930853,5.01458253 11.0889969,4.92993888 L10.9246212,4.9246212 L8.9246212,4.9246212 L8.9246212,3.9246212 L10.9246212,3.9246212 Z M9.4246212,6.9246212 L9.4246212,7.9246212 L5.4246212,7.9246212 L5.4246212,6.9246212 L9.4246212,6.9246212 Z\" fill=\"currentColor\" fillRule=\"nonzero\" transform=\"translate(7.424621, 7.424621) rotate(-315.000000) translate(-7.424621, -7.424621) \" />\n            </g>\n          </g>\n        </svg>\n      `;\n      shape.labelDom.setSuffix(icon);\n      shape.labelDom.onPositionChange = () => this.updateConnection(instanceItem, camera, icon);\n      return icon;\n    }\n    return null;\n  }\n\n  /**\n   * remove icon from shape\n   * @param instanceItem\n   */\n  removeIcon(instanceItem: InstanceItem) {\n    const shape = this.rootStore.shape.getShapeByInstanceItem(instanceItem);\n    if (shape && shape.labelDom) {\n      shape.labelDom.setSuffix();\n    }\n  }\n\n  /**\n   * handle mouse move\n   * @param event\n   */\n  handleMouseMove = (event: MouseEvent) => {\n    if (this.settingRelationship) {\n      const to = {\n        x: event.clientX,\n        y: event.clientY,\n      };\n      if (!this.currentConnection) {\n        const fromRect = this.fromIcon!.getBoundingClientRect();\n        const from = {\n          x: fromRect.x + fromRect.width,\n          y: fromRect.y + fromRect.height / 2,\n        };\n        this.currentConnection = new Connection({\n          containerId: `${CAMERA_VIEW_CONNECTIONS}-${this.rootStore.frame.currentCamera}`,\n          from,\n          to,\n          text: this.options[this.activeOptionIndex].name,\n        });\n      } else {\n        this.currentConnection.to = to;\n      }\n    }\n  };\n\n  /**\n   * handle relationship click\n   * @param relationship\n   */\n  handleClick = (relationship: Relationship) => {\n    this.editingRelationship = relationship;\n    if (this.editingConnection) {\n      this.editingConnection.selected = true;\n    }\n    this.rootStore.config.setRelationshipModalVisible(true);\n    this.rootStore.instance.selectInstanceItem(relationship.fromInstanceItem);\n  };\n\n  /**\n   * handle relationship right click\n   * @param relationship\n   */\n  handleRightClick = (relationship: Relationship) => {\n    this.editingRelationship = relationship;\n    this.rootStore.config.setRelationshipMenuVisible(true);\n    this.rootStore.instance.selectInstanceItem(relationship.fromInstanceItem);\n  };\n\n  /**\n   * switch from & to for editing relationship\n   */\n  switch = () => {\n    if (this.editingRelationship) {\n      const storeId = this.rootStore.undo.preserve({ relationships: [this.editingRelationship.toJSON()] });\n      this.editingRelationship.switch();\n      this.rootStore.undo.save(storeId, { relationships: [this.editingRelationship.toJSON()] });\n      this.deleteConnection(this.editingRelationship);\n      this.createConnection(this.editingRelationship);\n    }\n  };\n\n  /**\n   * update name for editing relationship\n   * @param name\n   */\n  updateName = (name: string) => {\n    if (this.editingRelationship) {\n      const storeId = this.rootStore.undo.preserve({ relationships: [this.editingRelationship.toJSON()] });\n      this.editingRelationship.relationship = name;\n      this.rootStore.undo.save(storeId, { relationships: [this.editingRelationship.toJSON()] });\n      const cid = this.connectionMap[this.editingRelationship.id];\n      const connection = this.connections[cid];\n      if (connection) {\n        connection.name = name;\n      }\n    }\n  };\n\n  /**\n   * delete editing relationship\n   */\n  deleteFromCurrentFrame = () => {\n    this.deleteFromFrames([this.rootStore.frame.currentFrame]);\n  };\n\n  /**\n   * delete editing relationship from frames\n   * @param frames\n   */\n  deleteFromFrames = (frames: number[]) => {\n    if (this.editingRelationship) {\n      const storeId = this.rootStore.undo.preserve({ relationships: [this.editingRelationship.toJSON()] });\n      const deletedFrames = this.editingRelationship.deleteFromFrames(frames);\n      if (frames.indexOf(this.rootStore.frame.currentFrame) >= 0) {\n        this.deleteConnection(this.editingRelationship);\n      }\n      if (this.editingRelationship.isEmpty) {\n        this.deleteRelationship(this.editingRelationship);\n      }\n      this.rootStore.undo.save(storeId, { relationships: [this.editingRelationship.toJSON()] });\n      message.success(i18n.translate('RELATIONSHIP_DELETE_MSG', { values: { frames: formatFrames(deletedFrames) } }));\n    }\n    this.finishUpdate();\n  };\n\n  /**\n   * copy editing relationship to next frame\n   */\n  copyToNextFrame = () => {\n    const { currentFrame, frameCount } = this.rootStore.frame;\n    if (currentFrame + 1 < frameCount) {\n      this.copyToFrames([currentFrame + 1]);\n    }\n  };\n\n  /**\n   * copy editing relationship to frames\n   * @param frames\n   */\n  copyToFrames = (frames: number[]) => {\n    if (this.editingRelationship) {\n      const storeId = this.rootStore.undo.preserve({ relationships: [this.editingRelationship.toJSON()] });\n      const { fromInstanceItem, toInstanceItem, fromCamera, toCamera } = this.editingRelationship;\n      const fromCameraData = fromInstanceItem.getCamera(fromCamera);\n      const toCameraData = toInstanceItem.getCamera(toCamera);\n      const successFrames = [];\n      for (let i = 0; i < frames.length; i += 1) {\n        const frameIndex = frames[i];\n        if (fromCameraData.frames[frameIndex] && toCameraData.frames[frameIndex] && !this.editingRelationship.frames[frameIndex]) {\n          // exists\n          this.editingRelationship.addToFrame(frameIndex);\n          successFrames.push(frameIndex);\n        }\n      }\n      this.rootStore.undo.save(storeId, { relationships: [this.editingRelationship.toJSON()] });\n      if (successFrames.length > 0) {\n        message.success(i18n.translate('RELATIONSHIP_COPY_MSG', { values: { frames: formatFrames(successFrames) } }));\n      } else {\n        message.success(i18n.translate('RELATIONSHIP_COPY_MSG_SKIP'));\n      }\n    }\n    this.finishUpdate();\n  };\n\n  /**\n   * finish editing\n   */\n  finishUpdate = () => {\n    this.rootStore.config.setRelationshipModalVisible(false);\n    this.rootStore.config.setRelationshipMenuVisible(false);\n    if (this.editingConnection) {\n      this.editingConnection.selected = false;\n    }\n    this.editingRelationship = null;\n    this.menuPosition = null;\n  };\n\n  /**\n   * copy relationships to current frame from last frame\n   * @param instanceItem\n   */\n  copyFromLastFrame = (instanceItem: InstanceItem) => {\n    const { currentCamera, currentFrame } = this.rootStore.frame;\n    const lastFrame = currentFrame - 1;\n    if (lastFrame < 0) {\n      return;\n    }\n    const { relationships } = instanceItem.getCamera(currentCamera);\n    if (relationships.length <= 0) {\n      return;\n    }\n\n    let successCount = 0;\n    let skipCount = 0;\n    const prevRelationships: IRelationship[] = [];\n    const currRelationships: IRelationship[] = [];\n    const { getShapeByInstanceItem } = this.rootStore.shape;\n    relationships.forEach((r) => {\n      const { frames, fromInstanceItem, toInstanceItem } = r;\n      if (frames[lastFrame] !== undefined && frames[currentFrame] === undefined) {\n        // exist in last frame, not in current frame\n        const relatedItem = fromInstanceItem === instanceItem ? toInstanceItem : fromInstanceItem;\n        const relatedShape = getShapeByInstanceItem(relatedItem);\n        if (relatedShape) {\n          // paste to current frame\n          prevRelationships.push(r.toJSON());\n          r.addToFrame(currentFrame);\n          currRelationships.push(r.toJSON());\n          this.createConnection(r);\n          successCount += 1;\n        } else {\n          skipCount += 1;\n        }\n      }\n    });\n    this.rootStore.undo.push({ relationships: prevRelationships }, { relationships: currRelationships });\n\n    let msg = '';\n    if (successCount > 0) {\n      msg = i18n.translate('RELATIONSHIP_LAST_FRAME_COPY_MSG_SUCCESS', { values: { count: successCount } });\n      if (skipCount > 0) {\n        msg = `${msg}; `;\n      }\n    }\n    if (skipCount > 0) {\n      msg = `${msg}${i18n.translate('RELATIONSHIP_LAST_FRAME_COPY_MSG_SKIP', { values: { count: skipCount } })}`;\n    }\n    message.success(msg);\n  };\n\n  /**\n   * open menu by relationship\n   * @param relationship\n   */\n  openMenuByRelationship = (relationship: Relationship, e: MouseEvent) => {\n    this.editingRelationship = relationship;\n    this.rootStore.config.setRelationshipMenuVisible(true);\n    const bbox = (e.target as HTMLElement).getBoundingClientRect();\n    this.menuPosition = {\n      x: bbox.left,\n      y: bbox.bottom,\n    };\n  };\n\n  /**\n   * delete from frames by instance item\n   * @param instanceItem\n   * @param camera\n   * @param frames\n   */\n  deleteFromFramesByInstanceItem = (instanceItem: InstanceItem, camera: string, frames: number[]) => {\n    const { currentFrame } = this.rootStore.frame;\n    const currentFrameIncluded = frames.indexOf(currentFrame) >= 0;\n    const { relationships } = instanceItem.getCamera(camera);\n    const prevRelationships: IRelationship[] = [];\n    const currRelationships: IRelationship[] = [];\n    [...relationships].forEach((r) => {\n      prevRelationships.push(r.toJSON());\n      r.deleteFromFrames(frames);\n      if (currentFrameIncluded) {\n        this.deleteConnection(r);\n      }\n      if (r.isEmpty) {\n        this.deleteRelationship(r);\n      } else {\n        currRelationships.push(r.toJSON());\n      }\n    });\n    return { prevRelationships, currRelationships };\n  };\n\n  /**\n   * setup relationships for instance item\n   * @param instanceItem\n   * @param camera\n   */\n  setupRelationshipsForInstanceItem(instanceItem: InstanceItem, camera?: string) {\n    this.relationships.forEach((r) => {\n      const { fromInstanceItem, toInstanceItem, fromCamera, toCamera } = r;\n      if (fromInstanceItem.id === instanceItem.id) {\n        if (!camera) {\n          instanceItem.removeRelationship(fromCamera, r);\n          instanceItem.addRelationship(fromCamera, r);\n        } else if (camera === fromCamera) {\n          instanceItem.removeRelationship(camera, r);\n          instanceItem.addRelationship(camera, r);\n        }\n        r.fromInstanceItem = instanceItem;\n      } else if (toInstanceItem.id === instanceItem.id) {\n        if (!camera) {\n          instanceItem.removeRelationship(toCamera, r);\n          instanceItem.addRelationship(toCamera, r);\n        } else if (camera === toCamera) {\n          instanceItem.removeRelationship(camera, r);\n          instanceItem.addRelationship(camera, r);\n        }\n        r.toInstanceItem = instanceItem;\n      }\n    });\n  }\n\n  /**\n   * setup connections for instance item\n   * @param instanceItem\n   */\n  setupConnectionsForInstanceItem(instanceItem: InstanceItem) {\n    const { currentCamera, currentFrame } = this.rootStore.frame;\n    const { relationships } = instanceItem.getCamera(currentCamera);\n    relationships.forEach((r) => {\n      if (r.frames[currentFrame]) {\n        this.deleteConnection(r);\n        this.createConnection(r);\n      }\n    });\n  }\n\n  /**\n   * update connections interactive\n   * @param interactive\n   */\n  updateConnectionsInteractive = (interactive: boolean) => {\n    Object.values(this.connections).forEach((c) => {\n      c.interactive = interactive;\n    });\n  };\n\n  /**\n   * update connection visible\n   * @param visible\n   */\n  updateConnectionsVisible = (visible: boolean) => {\n    Object.values(this.connections).forEach((c) => {\n      c.visible = visible;\n    });\n  };\n\n  /**\n   * on shape hovered, update connections visibility\n   * @param shapeId\n   */\n  onShapeHovered = (shapeId: string) => {\n    const { activeRelationshipsMode } = this.rootStore.config;\n    if (activeRelationshipsMode === AttributesMode.HOVER) {\n      this.updateConnectionsVisible(false);\n      const { instanceItem } = this.rootStore.shape.shapes[shapeId] || {};\n      if (instanceItem) {\n        const { relationships } = instanceItem.getCamera(this.rootStore.frame.currentCamera);\n        relationships.forEach((r) => {\n          const cid = this.connectionMap[r.id];\n          const connection = this.connections[cid];\n          if (connection && this.visibleConnectionIds.indexOf(cid) >= 0) {\n            connection.visible = true;\n          }\n        });\n      }\n    }\n  };\n\n  /**\n   * hide or show relationships by visible instance items\n   */\n  hideOrShowRelationships() {\n    const { activeRelationshipsMode } = this.rootStore.config;\n    const { shapes, visibleShapeIds } = this.rootStore.shape;\n\n    const visibleConnectionIds = new Set<string>();\n    visibleShapeIds.forEach((sid) => {\n      const shapeInfo = shapes[sid];\n      if (shapeInfo) {\n        const { instanceItem } = shapeInfo;\n        Object.values(instanceItem.cameras).forEach(({ relationships }) => {\n          relationships.forEach((relationship) => {\n            const { id, fromInstanceItem, toInstanceItem } = relationship;\n            const cid = this.connectionMap[id];\n            const connection = this.connections[cid];\n            if (connection) {\n              const otherInstanceItem = instanceItem === fromInstanceItem ? toInstanceItem : fromInstanceItem;\n              if (visibleShapeIds.findIndex((oid) => shapes[oid]?.instanceItem.id === otherInstanceItem.id) >= 0) {\n                visibleConnectionIds.add(cid);\n              }\n            }\n          });\n        });\n      }\n    });\n    this.visibleConnectionIds = Array.from(visibleConnectionIds);\n\n    Object.values(this.connections).forEach((connection) => {\n      if (visibleConnectionIds.has(connection.id)) {\n        connection.visible = activeRelationshipsMode === AttributesMode.ALWAYS;\n      } else {\n        connection.visible = false;\n      }\n    });\n  }\n\n  /**\n   * get relationships json data (for save)\n   */\n  relationshipsJSON(): IRelationship[] {\n    return this.relationships.map((r) => r.toJSON());\n  }\n}\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module"}