{"ast":null,"code":"import React from'react';import{connect}from'react-redux';import{isEqual}from'lodash';import EasyForm,{utils as formUtils}from'@appen-china/easy-form';import{FieldControlType}from'@appen-china/easy-form/es/types';import{translate,validateForm}from'../../constants';import*as actions from'../../redux/action';import{isEasyformSelectDropdown}from'../../../../utils';import{getFieldDisplayLabel}from'../../../../utils/form';import{isAnnotationReadonly}from'../../../../utils/tool-mode';import'./GlobalAttributes.scss';class GlobalAttributes extends React.Component{constructor(){super(...arguments);this.container=React.createRef();this.state={editing:true,fieldsMap:{}};this.handleClick=e=>{if(isEasyformSelectDropdown(e.target)){e.stopPropagation();return;}const video=this.props.videos[this.props.currentVideo];if(!this.readonly&&this.container.current&&video){if(this.container.current.contains(e.target)){if(!this.state.editing){video.attributes={...video.defaultAttributes,...video.originAttributes,...video.attributes};this.setState({editing:true});}}else if(this.state.editing){const isValid=validateForm(this.props.globalConfig,video.attributes);// collapse\nif(isValid){this.setState({editing:false});}}}};this.handleChange=value=>{this.props.setVideoAttributes({index:this.props.currentVideo,attributes:value});};}get readonly(){return isAnnotationReadonly(this.props.toolMode);}componentDidMount(){window.addEventListener('mousedown',this.handleClick);this.setState({editing:!this.readonly});this.updateFiledsMap();}componentDidUpdate(prevProps){if(prevProps.currentVideo!==this.props.currentVideo){this.setState({editing:!this.readonly});}if(!isEqual(prevProps.globalConfig,this.props.globalConfig)){this.updateFiledsMap();}}componentWillUnmount(){window.removeEventListener('mousedown',this.handleClick);}updateFiledsMap(){const{fields=[]}=this.props.globalConfig||{};const map={};fields.forEach(field=>{const{name,label,type,valueType,options=[]}=field;const newField={name,type,label};if(type===FieldControlType.RADIO||type===FieldControlType.SELECT||type===FieldControlType.CHECKBOX||type===FieldControlType.CASCADER){// has options\nnewField.options=formUtils.parseOptions(options,valueType);}map[name]=newField;});this.setState({fieldsMap:map});}renderAttrs(attributes){const allValues=[];Object.keys(attributes).forEach(fieldName=>{const field=this.state.fieldsMap[fieldName];const fieldValue=attributes[fieldName];if(fieldValue!==undefined&&fieldValue!==''){if(field===null||field===void 0?void 0:field.options){const displayValue=getFieldDisplayLabel(fieldValue,field);allValues.push(displayValue);}else{allValues.push(fieldValue.toString());}}});return allValues.join('; ');}render(){const{videos,currentVideo,globalConfig}=this.props;if(!globalConfig||!globalConfig.fields||globalConfig.fields.length===0){// no global config\nreturn null;}const video=videos[currentVideo];if(!video||!video.ready){// no video, or video not ready\nreturn null;}const{attributes={}}=video;const fields=globalConfig.fields.map(f=>({...f,...(attributes[f.name]!==undefined&&{defaultValue:attributes[f.name]})}));return/*#__PURE__*/React.createElement(\"div\",{ref:this.container,className:\"global-attributes-container\"},/*#__PURE__*/React.createElement(\"div\",{className:\"header\"},translate('GLOBAL_ATTR_TITLE')),/*#__PURE__*/React.createElement(\"div\",{className:\"content\"},this.state.editing?/*#__PURE__*/React.createElement(React.Fragment,null,/*#__PURE__*/React.createElement(\"div\",{style:{color:'#FFFFFF'}},translate('GLOBAL_ATTR_SUBTITLE')),/*#__PURE__*/React.createElement(EasyForm,{theme:\"dark\",autoFocus:false,fields:fields,conditions:globalConfig.conditions,effects:globalConfig.effects,rules:globalConfig.rules,onChange:this.handleChange})):this.renderAttrs(attributes)));}}const mapStateToProps=state=>({toolMode:state.toolMode,videos:state.videos,currentVideo:state.currentVideo,globalConfig:state.globalConfig});const mapDispatchToProps={setVideoAttributes:actions.setVideoAttributes};export default connect(mapStateToProps,mapDispatchToProps)(GlobalAttributes);","map":{"version":3,"names":["React","connect","isEqual","EasyForm","utils","formUtils","FieldControlType","translate","validateForm","actions","isEasyformSelectDropdown","getFieldDisplayLabel","isAnnotationReadonly","GlobalAttributes","Component","constructor","arguments","container","createRef","state","editing","fieldsMap","handleClick","e","target","stopPropagation","video","props","videos","currentVideo","readonly","current","contains","attributes","defaultAttributes","originAttributes","setState","isValid","globalConfig","handleChange","value","setVideoAttributes","index","toolMode","componentDidMount","window","addEventListener","updateFiledsMap","componentDidUpdate","prevProps","componentWillUnmount","removeEventListener","fields","map","forEach","field","name","label","type","valueType","options","newField","RADIO","SELECT","CHECKBOX","CASCADER","parseOptions","renderAttrs","allValues","Object","keys","fieldName","fieldValue","undefined","displayValue","push","toString","join","render","length","ready","f","defaultValue","createElement","ref","className","Fragment","style","color","theme","autoFocus","conditions","effects","rules","onChange","mapStateToProps","mapDispatchToProps"],"sources":["/Users/qzheng/Documents/webroot/annotation_tools/src/components/long-audio/components/GlobalAttributes/GlobalAttributes.jsx"],"sourcesContent":["import React from 'react';\nimport { connect } from 'react-redux';\nimport { isEqual } from 'lodash';\nimport EasyForm, { utils as formUtils } from '@appen-china/easy-form';\nimport { FieldControlType } from '@appen-china/easy-form/es/types';\nimport { translate, validateForm } from '../../constants';\nimport * as actions from '../../redux/action';\nimport { isEasyformSelectDropdown } from '../../../../utils';\nimport { getFieldDisplayLabel } from '../../../../utils/form';\nimport { isAnnotationReadonly } from '../../../../utils/tool-mode';\nimport './GlobalAttributes.scss';\n\nclass GlobalAttributes extends React.Component {\n  container = React.createRef();\n\n  state = {\n    editing: true,\n    fieldsMap: {},\n  };\n\n  get readonly() {\n    return isAnnotationReadonly(this.props.toolMode);\n  }\n\n  componentDidMount() {\n    window.addEventListener('mousedown', this.handleClick);\n    this.setState({ editing: !this.readonly });\n    this.updateFiledsMap();\n  }\n\n  componentDidUpdate(prevProps) {\n    if (prevProps.currentVideo !== this.props.currentVideo) {\n      this.setState({ editing: !this.readonly });\n    }\n    if (!isEqual(prevProps.globalConfig, this.props.globalConfig)) {\n      this.updateFiledsMap();\n    }\n  }\n\n  componentWillUnmount() {\n    window.removeEventListener('mousedown', this.handleClick);\n  }\n\n  updateFiledsMap() {\n    const { fields = [] } = this.props.globalConfig || {};\n    const map = {};\n    fields.forEach((field) => {\n      const { name, label, type, valueType, options = [] } = field;\n      const newField = { name, type, label };\n      if (type === FieldControlType.RADIO || type === FieldControlType.SELECT || type === FieldControlType.CHECKBOX || type === FieldControlType.CASCADER) {\n        // has options\n        newField.options = formUtils.parseOptions(options, valueType);\n      }\n      map[name] = newField;\n    });\n    this.setState({ fieldsMap: map });\n  }\n\n  handleClick = (e) => {\n    if (isEasyformSelectDropdown(e.target)) {\n      e.stopPropagation();\n      return;\n    }\n    const video = this.props.videos[this.props.currentVideo];\n    if (!this.readonly && this.container.current && video) {\n      if (this.container.current.contains(e.target)) {\n        if (!this.state.editing) {\n          video.attributes = { ...video.defaultAttributes, ...video.originAttributes, ...video.attributes };\n          this.setState({ editing: true });\n        }\n      } else if (this.state.editing) {\n        const isValid = validateForm(this.props.globalConfig, video.attributes);\n        // collapse\n        if (isValid) {\n          this.setState({ editing: false });\n        }\n      }\n    }\n  };\n\n  handleChange = (value) => {\n    this.props.setVideoAttributes({ index: this.props.currentVideo, attributes: value });\n  };\n\n  renderAttrs(attributes) {\n    const allValues = [];\n    Object.keys(attributes).forEach((fieldName) => {\n      const field = this.state.fieldsMap[fieldName];\n      const fieldValue = attributes[fieldName];\n      if (fieldValue !== undefined && fieldValue !== '') {\n        if (field?.options) {\n          const displayValue = getFieldDisplayLabel(fieldValue, field);\n          allValues.push(displayValue);\n        } else {\n          allValues.push(fieldValue.toString());\n        }\n      }\n    });\n    return allValues.join('; ');\n  }\n\n  render() {\n    const { videos, currentVideo, globalConfig } = this.props;\n\n    if (!globalConfig || !globalConfig.fields || globalConfig.fields.length === 0) {\n      // no global config\n      return null;\n    }\n\n    const video = videos[currentVideo];\n    if (!video || !video.ready) {\n      // no video, or video not ready\n      return null;\n    }\n\n    const { attributes = {} } = video;\n    const fields = globalConfig.fields.map((f) => ({\n      ...f,\n      ...attributes[f.name] !== undefined && {\n        defaultValue: attributes[f.name],\n      },\n    }));\n\n    return (\n      <div ref={this.container} className=\"global-attributes-container\">\n        <div className=\"header\">\n          {translate('GLOBAL_ATTR_TITLE')}\n        </div>\n        <div className=\"content\">\n          {this.state.editing ? (\n            <>\n              <div style={{ color: '#FFFFFF' }}>{translate('GLOBAL_ATTR_SUBTITLE')}</div>\n              <EasyForm\n                theme=\"dark\"\n                autoFocus={false}\n                fields={fields}\n                conditions={globalConfig.conditions}\n                effects={globalConfig.effects}\n                rules={globalConfig.rules}\n                onChange={this.handleChange}\n              />\n            </>\n          ) : this.renderAttrs(attributes)}\n        </div>\n      </div>\n    );\n  }\n}\n\nconst mapStateToProps = (state) => ({\n  toolMode: state.toolMode,\n  videos: state.videos,\n  currentVideo: state.currentVideo,\n  globalConfig: state.globalConfig,\n});\nconst mapDispatchToProps = {\n  setVideoAttributes: actions.setVideoAttributes,\n};\nexport default connect(mapStateToProps, mapDispatchToProps)(GlobalAttributes);\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module"}