{"ast":null,"code":"// decorator class copied from\n// https://github.com/facebookarchive/draft-js/blob/main/src/model/decorators/CompositeDraftDecorator.js\nimport{CompositeDecorator}from'draft-js';import Prism from'prismjs';import{List}from'immutable';import Decoration from'./Decoration';import{CODE_BLOCK_TYPE}from'../constants';import normalizeTokens from'../../../code/normalizeTokens';// load language essentials\nimport'prismjs/components/prism-json';import'prismjs/components/prism-javascript';import'prismjs/components/prism-jsx';import'prismjs/components/prism-typescript';import'prismjs/components/prism-tsx';import'prismjs/components/prism-markdown';import'prismjs/components/prism-python';import'prismjs/components/prism-php';import'prismjs/components/prism-sql';import'prismjs/components/prism-java';const DELIMITER='.';/**\n * Determine whether we can occupy the specified slice of the decorations\n * array.\n */function canOccupySlice(decorations,start,end){for(let ii=start;ii<end;ii+=1){if(decorations[ii]!=null){return false;}}return true;}/**\n * Splice the specified component into our decoration array at the desired\n * range.\n */function occupySlice(targetArr,start,end,componentKey){for(let ii=start;ii<end;ii+=1){targetArr[ii]=componentKey;}}class ExtendedDecorator extends CompositeDecorator{constructor(decorators){super(decorators);this._decorators=[];this._props={};this._decorators=decorators.slice();this._props={};}getDecorations(block,contentState){const decorations=Array(block.getText().length).fill(null);this._decorators.forEach((decorator,ii)=>{let counter=0;const strategy=decorator.strategy;const getDecorationsChecker=(start,end,props)=>{if(canOccupySlice(decorations,start,end)){const key=ii+DELIMITER+counter+DELIMITER+block.getKey();occupySlice(decorations,start,end,key);this._props[key]={...props};counter+=1;}};strategy(block,getDecorationsChecker,contentState);});return List(decorations);}getPropsForKey(key){const componentKey=parseInt(key.split(DELIMITER)[0],10);return{...this._decorators[componentKey].props,...this._props[key]};}}export default new ExtendedDecorator([{strategy:(contentBlock,callback)=>{if(contentBlock.getType()===CODE_BLOCK_TYPE){const language=contentBlock.getData().get('language');if(language){const tokens=Prism.tokenize(contentBlock.getText(),Prism.languages[language]);const normalizedTokens=normalizeTokens(tokens);for(let i=0;i<normalizedTokens.length;i+=1){const lineTokens=normalizedTokens[i];let start=0;for(let j=0;j<lineTokens.length;j+=1){const token=lineTokens[j];const end=start+token.content.length;callback(start,end,{types:token.types});start=end;}}}}},component:Decoration}]);","map":{"version":3,"names":["CompositeDecorator","Prism","List","Decoration","CODE_BLOCK_TYPE","normalizeTokens","DELIMITER","canOccupySlice","decorations","start","end","ii","occupySlice","targetArr","componentKey","ExtendedDecorator","constructor","decorators","_decorators","_props","slice","getDecorations","block","contentState","Array","getText","length","fill","forEach","decorator","counter","strategy","getDecorationsChecker","props","key","getKey","getPropsForKey","parseInt","split","contentBlock","callback","getType","language","getData","get","tokens","tokenize","languages","normalizedTokens","i","lineTokens","j","token","content","types","component"],"sources":["/Users/qzheng/Documents/webroot/annotation_tools/src/components/common/llm/input/decorators/prism-decorator.ts"],"sourcesContent":["// decorator class copied from\n// https://github.com/facebookarchive/draft-js/blob/main/src/model/decorators/CompositeDraftDecorator.js\n\nimport { CompositeDecorator, ContentBlock, ContentState, DraftDecorator } from 'draft-js';\nimport Prism from 'prismjs';\nimport { List } from 'immutable';\nimport Decoration from './Decoration';\nimport { CODE_BLOCK_TYPE } from '../constants';\nimport normalizeTokens from '../../../code/normalizeTokens';\n\n// load language essentials\nimport 'prismjs/components/prism-json';\nimport 'prismjs/components/prism-javascript';\nimport 'prismjs/components/prism-jsx';\nimport 'prismjs/components/prism-typescript';\nimport 'prismjs/components/prism-tsx';\nimport 'prismjs/components/prism-markdown';\nimport 'prismjs/components/prism-python';\nimport 'prismjs/components/prism-php';\nimport 'prismjs/components/prism-sql';\nimport 'prismjs/components/prism-java';\n\nconst DELIMITER = '.';\n\n/**\n * Determine whether we can occupy the specified slice of the decorations\n * array.\n */\nfunction canOccupySlice(\n  decorations: (string | null)[],\n  start: number,\n  end: number,\n): boolean {\n  for (let ii = start; ii < end; ii += 1) {\n    if (decorations[ii] != null) {\n      return false;\n    }\n  }\n  return true;\n}\n\n/**\n * Splice the specified component into our decoration array at the desired\n * range.\n */\nfunction occupySlice(\n  targetArr: (string | null)[],\n  start: number,\n  end: number,\n  componentKey: string,\n): void {\n  for (let ii = start; ii < end; ii += 1) {\n    targetArr[ii] = componentKey;\n  }\n}\n\ninterface ExtendedDraftDecorator extends DraftDecorator {\n  strategy: (\n    block: ContentBlock,\n    callback: (start: number, end: number, props: any) => void,\n    contentState: ContentState,\n  ) => void;\n}\n\nclass ExtendedDecorator extends CompositeDecorator {\n  _decorators: ExtendedDraftDecorator[] = [];\n\n  _props: Record<string, any> = {};\n\n  constructor(decorators: ExtendedDraftDecorator[]) {\n    super(decorators);\n    this._decorators = decorators.slice();\n    this._props = {};\n  }\n\n  getDecorations(block: ContentBlock, contentState: ContentState) {\n    const decorations = Array(block.getText().length).fill(null);\n\n    this._decorators.forEach((decorator: ExtendedDraftDecorator, ii: number) => {\n      let counter = 0;\n      const strategy = decorator.strategy;\n      const getDecorationsChecker = (start: number, end: number, props: any) => {\n        if (canOccupySlice(decorations, start, end)) {\n          const key = ii + DELIMITER + counter + DELIMITER + block.getKey();\n          occupySlice(decorations, start, end, key);\n          this._props[key] = { ...props };\n          counter += 1;\n        }\n      };\n      strategy(block, getDecorationsChecker, contentState);\n    });\n\n    return List(decorations);\n  }\n\n  getPropsForKey(key: string) {\n    const componentKey = parseInt(key.split(DELIMITER)[0], 10);\n    return {\n      ...this._decorators[componentKey].props,\n      ...this._props[key],\n    };\n  }\n}\n\nexport default new ExtendedDecorator([{\n  strategy: (contentBlock, callback) => {\n    if (contentBlock.getType() === CODE_BLOCK_TYPE) {\n      const language = contentBlock.getData().get('language');\n      if (language) {\n        const tokens = Prism.tokenize(contentBlock.getText(), Prism.languages[language]);\n        const normalizedTokens = normalizeTokens(tokens);\n        for (let i = 0; i < normalizedTokens.length; i += 1) {\n          const lineTokens = normalizedTokens[i];\n\n          let start = 0;\n          for (let j = 0; j < lineTokens.length; j += 1) {\n            const token = lineTokens[j];\n            const end = start + token.content.length;\n            callback(start, end, {\n              types: token.types,\n            });\n            start = end;\n          }\n        }\n      }\n    }\n  },\n  component: Decoration,\n}]);\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module"}