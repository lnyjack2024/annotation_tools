{"ast":null,"code":"export var REGISTRY_FINALIZE_AFTER = 10000;\nexport var REGISTRY_SWEEP_INTERVAL = 10000;\nvar TimerBasedFinalizationRegistry = /** @class */function () {\n  function TimerBasedFinalizationRegistry(finalize) {\n    var _this = this;\n    Object.defineProperty(this, \"finalize\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: finalize\n    });\n    Object.defineProperty(this, \"registrations\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: new Map()\n    });\n    Object.defineProperty(this, \"sweepTimeout\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: void 0\n    });\n    // Bound so it can be used directly as setTimeout callback.\n    Object.defineProperty(this, \"sweep\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: function (maxAge) {\n        if (maxAge === void 0) {\n          maxAge = REGISTRY_FINALIZE_AFTER;\n        }\n        // cancel timeout so we can force sweep anytime\n        clearTimeout(_this.sweepTimeout);\n        _this.sweepTimeout = undefined;\n        var now = Date.now();\n        _this.registrations.forEach(function (registration, token) {\n          if (now - registration.registeredAt >= maxAge) {\n            _this.finalize(registration.value);\n            _this.registrations.delete(token);\n          }\n        });\n        if (_this.registrations.size > 0) {\n          _this.scheduleSweep();\n        }\n      }\n    });\n    // Bound so it can be exported directly as clearTimers test utility.\n    Object.defineProperty(this, \"finalizeAllImmediately\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: function () {\n        _this.sweep(0);\n      }\n    });\n  }\n  // Token is actually required with this impl\n  Object.defineProperty(TimerBasedFinalizationRegistry.prototype, \"register\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (target, value, token) {\n      this.registrations.set(token, {\n        value: value,\n        registeredAt: Date.now()\n      });\n      this.scheduleSweep();\n    }\n  });\n  Object.defineProperty(TimerBasedFinalizationRegistry.prototype, \"unregister\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (token) {\n      this.registrations.delete(token);\n    }\n  });\n  Object.defineProperty(TimerBasedFinalizationRegistry.prototype, \"scheduleSweep\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function () {\n      if (this.sweepTimeout === undefined) {\n        this.sweepTimeout = setTimeout(this.sweep, REGISTRY_SWEEP_INTERVAL);\n      }\n    }\n  });\n  return TimerBasedFinalizationRegistry;\n}();\nexport { TimerBasedFinalizationRegistry };\nexport var UniversalFinalizationRegistry = typeof FinalizationRegistry !== \"undefined\" ? FinalizationRegistry : TimerBasedFinalizationRegistry;","map":{"version":3,"sources":["../../src/utils/UniversalFinalizationRegistry.ts"],"names":[],"mappings":"AAQA,OAAO,IAAM,uBAAuB,GAAG,KAAM;AAC7C,OAAO,IAAM,uBAAuB,GAAG,KAAM;AAE7C,IAAA,8BAAA,GAAA,aAAA,YAAA;EAII,SAAA,8BAAA,CAA6B,QAA4B,EAAA;IAAzD,IAAA,KAAA,GAAA,IAAA;;;;;aAA6B;;IAH7B,MAAA,CAAA,cAAA,CAAA,IAAA,EAAA,eAAA,EAAA;;;;aAA0E,IAAI,GAAG,CAAA;MAAE;IACnF,MAAA,CAAA,cAAA,CAAA,IAAA,EAAA,cAAA,EAAA;;;;;MAA+D;IAiB/D;IACA,MAAA,CAAA,cAAA,CAAA,IAAA,EAAA,OAAA,EAAA;;;;aAAQ,SAAA,CAAC,MAAgC,EAAA;QAAhC,IAAA,MAAA,KAAA,KAAA,CAAA,EAAA;UAAA,MAAA,GAAA,uBAAgC;QAAA;QACrC;QACA,YAAY,CAAC,KAAI,CAAC,YAAY,CAAC;QAC/B,KAAI,CAAC,YAAY,GAAG,SAAS;QAE7B,IAAM,GAAG,GAAG,IAAI,CAAC,GAAG,CAAA,CAAE;QACtB,KAAI,CAAC,aAAa,CAAC,OAAO,CAAC,UAAC,YAAY,EAAE,KAAK,EAAA;UAC3C,IAAI,GAAG,GAAG,YAAY,CAAC,YAAY,IAAI,MAAM,EAAE;YAC3C,KAAI,CAAC,QAAQ,CAAC,YAAY,CAAC,KAAK,CAAC;YACjC,KAAI,CAAC,aAAa,CAAC,MAAM,CAAC,KAAK,CAAC;UACnC;QACL,CAAC,CAAC;QAEF,IAAI,KAAI,CAAC,aAAa,CAAC,IAAI,GAAG,CAAC,EAAE;UAC7B,KAAI,CAAC,aAAa,CAAA,CAAE;QACvB;MACL;MAAC;IAED;IACA,MAAA,CAAA,cAAA,CAAA,IAAA,EAAA,wBAAA,EAAA;;;;aAAyB,SAAA,CAAA,EAAA;QACrB,KAAI,CAAC,KAAK,CAAC,CAAC,CAAC;MACjB;MAAC;EArC2D;EAE5D;;;;;WACA,SAAA,CAAS,MAAc,EAAE,KAAQ,EAAE,KAAc,EAAA;MAC7C,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC,KAAK,EAAE;QAC1B,KAAK,EAAA,KAAA;QACL,YAAY,EAAE,IAAI,CAAC,GAAG,CAAA;OACzB,CAAC;MACF,IAAI,CAAC,aAAa,CAAA,CAAE;IACxB;;;;;;WAEA,SAAA,CAAW,KAAc,EAAA;MACrB,IAAI,CAAC,aAAa,CAAC,MAAM,CAAC,KAAK,CAAC;IACpC;;;;;;WA0BA,SAAA,CAAA,EAAA;MACI,IAAI,IAAI,CAAC,YAAY,KAAK,SAAS,EAAE;QACjC,IAAI,CAAC,YAAY,GAAG,UAAU,CAAC,IAAI,CAAC,KAAK,EAAE,uBAAuB,CAAC;MACtE;IACL;;EACJ,OAAA,8BAAC;AAAD,CAAC,CAAA,CAAA;;AAED,OAAO,IAAM,6BAA6B,GACtC,OAAO,oBAAoB,KAAK,WAAW,GACrC,oBAAoB,GACpB,8BAA8B","sourceRoot":"","sourcesContent":["export var REGISTRY_FINALIZE_AFTER = 10000;\nexport var REGISTRY_SWEEP_INTERVAL = 10000;\nvar TimerBasedFinalizationRegistry = /** @class */ (function () {\n    function TimerBasedFinalizationRegistry(finalize) {\n        var _this = this;\n        Object.defineProperty(this, \"finalize\", {\n            enumerable: true,\n            configurable: true,\n            writable: true,\n            value: finalize\n        });\n        Object.defineProperty(this, \"registrations\", {\n            enumerable: true,\n            configurable: true,\n            writable: true,\n            value: new Map()\n        });\n        Object.defineProperty(this, \"sweepTimeout\", {\n            enumerable: true,\n            configurable: true,\n            writable: true,\n            value: void 0\n        });\n        // Bound so it can be used directly as setTimeout callback.\n        Object.defineProperty(this, \"sweep\", {\n            enumerable: true,\n            configurable: true,\n            writable: true,\n            value: function (maxAge) {\n                if (maxAge === void 0) { maxAge = REGISTRY_FINALIZE_AFTER; }\n                // cancel timeout so we can force sweep anytime\n                clearTimeout(_this.sweepTimeout);\n                _this.sweepTimeout = undefined;\n                var now = Date.now();\n                _this.registrations.forEach(function (registration, token) {\n                    if (now - registration.registeredAt >= maxAge) {\n                        _this.finalize(registration.value);\n                        _this.registrations.delete(token);\n                    }\n                });\n                if (_this.registrations.size > 0) {\n                    _this.scheduleSweep();\n                }\n            }\n        });\n        // Bound so it can be exported directly as clearTimers test utility.\n        Object.defineProperty(this, \"finalizeAllImmediately\", {\n            enumerable: true,\n            configurable: true,\n            writable: true,\n            value: function () {\n                _this.sweep(0);\n            }\n        });\n    }\n    // Token is actually required with this impl\n    Object.defineProperty(TimerBasedFinalizationRegistry.prototype, \"register\", {\n        enumerable: false,\n        configurable: true,\n        writable: true,\n        value: function (target, value, token) {\n            this.registrations.set(token, {\n                value: value,\n                registeredAt: Date.now()\n            });\n            this.scheduleSweep();\n        }\n    });\n    Object.defineProperty(TimerBasedFinalizationRegistry.prototype, \"unregister\", {\n        enumerable: false,\n        configurable: true,\n        writable: true,\n        value: function (token) {\n            this.registrations.delete(token);\n        }\n    });\n    Object.defineProperty(TimerBasedFinalizationRegistry.prototype, \"scheduleSweep\", {\n        enumerable: false,\n        configurable: true,\n        writable: true,\n        value: function () {\n            if (this.sweepTimeout === undefined) {\n                this.sweepTimeout = setTimeout(this.sweep, REGISTRY_SWEEP_INTERVAL);\n            }\n        }\n    });\n    return TimerBasedFinalizationRegistry;\n}());\nexport { TimerBasedFinalizationRegistry };\nexport var UniversalFinalizationRegistry = typeof FinalizationRegistry !== \"undefined\"\n    ? FinalizationRegistry\n    : TimerBasedFinalizationRegistry;\n//# sourceMappingURL=UniversalFinalizationRegistry.js.map"]},"metadata":{},"sourceType":"module"}