{"ast":null,"code":"import{makeAutoObservable,toJS}from'mobx';import{strlen,substr}from'fbjs/lib/UnicodeUtils';import{v4 as uuidv4}from'uuid';import{findIndex}from'lodash';import{ReviewItemResult,TAG}from'../types';import{isLabel}from'./tag_mode';import{getConfigByKeys}from'../utils/helper';/**\n * store for config\n * @class\n */export default class ReviewStore{get allReviews(){return Object.entries(this.reviews.data).map(_ref=>{let[index,reviewInfo]=_ref;return{...reviewInfo,id:index};});}/**\n * rejected count\n * @getter\n */get rejectedCount(){const reviews=this.allReviews.filter(r=>r.result===ReviewItemResult.REJECT);return reviews.length;}/**\n * rejected count\n * @getter\n */get unPassedCount(){const reviews=this.allReviews.filter(r=>r.result!==ReviewItemResult.PASS);return reviews.length;}get passedCount(){const reviews=this.allReviews.filter(r=>r.result===ReviewItemResult.PASS);return reviews.length;}constructor(rootStore){/**\n   * root store\n   */this.rootStore=void 0;this.text='';this.reviews={data:{},missing:[]};/**\n * anchors visible\n */this.visible=true;makeAutoObservable(this,{rootStore:false},{autoBind:true});this.rootStore=rootStore;}/**\n   * init from paylod\n   * @param payload\n   */init(payload){const{content}=payload;this.text=content;}parseReview(reviews){const length=strlen(this.text);const{ontologyConfigMap}=this.rootStore.ontology;this.reviews.data=reviews.data||{};if(reviews.missing){this.reviews.missing=reviews.missing.filter(label=>{var _getConfigByKeys;// invalid start & end\nif(typeof label!=='object')return false;if(Number.isNaN(label.start)||label.start===null||label.start<0||label.start>=length){return false;}if(Number.isNaN(label.end)||label.end===null||label.end<0||label.end>=length){return false;}if(!label.keys){ontologyConfigMap.forEach((value,key)=>{const keys=value.keys;if(keys[keys.length-1]===label.value){label.keys=value.keys;}});}// invalid value\nif(!isLabel((_getConfigByKeys=getConfigByKeys(ontologyConfigMap,label.keys))===null||_getConfigByKeys===void 0?void 0:_getConfigByKeys.type)){return false;}// invalid & missing id\nif(!label.id){label.id=uuidv4();}if(!label.type){label.type=TAG.LABEL_QA;}// missing text\nif(!label.text)label.text=substr(this.text,label.start,label.end-label.start);return true;});}}addMissingReview(newItem,id,data){const{reviews}=this;const{missing}=reviews;missing.unshift(newItem);missing.sort((a,b)=>a.start-b.start);const preReview=reviews.data[id];reviews.data[id]=data;reviews.data={...reviews.data};return{review:{...data},preReview,id,label:newItem};}setReview(id,data){const{reviews}=this;const preReview=reviews.data[id];reviews.data[id]=data;reviews.data={...reviews.data};return{review:{...data},preReview,id};}getReview(id){if(!id){return null;}return this.reviews.data[id];}getReviews(){const{missing,data}=this.reviews;return{data:toJS(data),missing:missing===null||missing===void 0?void 0:missing.map(item=>toJS(item))};}deleteReview(id){const reviewData={...this.reviews.data[id]};delete this.reviews.data[id];return{review:reviewData,id};}deleteReviews(ids){const reviewDataList=[];ids.forEach(id=>{const reviewData=this.deleteReview(id);reviewDataList.push({...reviewData,id});});return{reviewDataList};}deleteMissingReview(id){const{missing,data}=this.reviews;const reviewData={...data[id]};const index=findIndex(missing,{id});const label=missing[index];missing.splice(index,1);delete data[id];return{review:reviewData,id,label};}}","map":{"version":3,"names":["makeAutoObservable","toJS","strlen","substr","v4","uuidv4","findIndex","ReviewItemResult","TAG","isLabel","getConfigByKeys","ReviewStore","allReviews","Object","entries","reviews","data","map","_ref","index","reviewInfo","id","rejectedCount","filter","r","result","REJECT","length","unPassedCount","PASS","passedCount","constructor","rootStore","text","missing","visible","autoBind","init","payload","content","parseReview","ontologyConfigMap","ontology","label","_getConfigByKeys","Number","isNaN","start","end","keys","forEach","value","key","type","LABEL_QA","addMissingReview","newItem","unshift","sort","a","b","preReview","review","setReview","getReview","getReviews","item","deleteReview","reviewData","deleteReviews","ids","reviewDataList","push","deleteMissingReview","splice"],"sources":["/Users/qzheng/Documents/webroot/annotation_tools/src/components/editable-text/store/ReviewStore.ts"],"sourcesContent":["import { makeAutoObservable, toJS } from 'mobx';\nimport { strlen, substr } from 'fbjs/lib/UnicodeUtils';\nimport { v4 as uuidv4 } from 'uuid';\nimport { findIndex } from 'lodash';\nimport RootStore from './RootStore';\nimport { MissingItem, Payload, ReviewDataItem, ReviewItemResult, ReviewResult, TAG } from '../types';\nimport { isLabel } from './tag_mode';\nimport { getConfigByKeys } from '../utils/helper';\n\n/**\n * store for config\n * @class\n */\nexport default class ReviewStore {\n  /**\n   * root store\n   */\n  rootStore;\n\n  text = '';\n\n  reviews: ReviewResult = {\n    data: {},\n    missing: [],\n  };\n\n  /**\n * anchors visible\n */\n  visible = true;\n\n  get allReviews() {\n    return Object.entries(this.reviews.data).map(([index, reviewInfo]) => ({\n      ...reviewInfo,\n      id: index\n    }));\n  }\n\n  /**\n * rejected count\n * @getter\n */\n  get rejectedCount() {\n    const reviews = this.allReviews.filter((r) => r.result === ReviewItemResult.REJECT);\n    return reviews.length;\n  }\n\n  /**\n * rejected count\n * @getter\n */\n  get unPassedCount() {\n    const reviews = this.allReviews.filter((r) => r.result !== ReviewItemResult.PASS);\n    return reviews.length;\n  }\n\n  get passedCount() {\n    const reviews = this.allReviews.filter((r) => r.result === ReviewItemResult.PASS);\n    return reviews.length;\n  }\n\n  constructor(rootStore: typeof RootStore) {\n    makeAutoObservable(this, {\n      rootStore: false,\n    }, {\n      autoBind: true,\n    });\n\n    this.rootStore = rootStore;\n  }\n\n  /**\n   * init from paylod\n   * @param payload\n   */\n  init(payload: Payload) {\n    const { content } = payload;\n\n    this.text = content;\n  }\n\n  parseReview(reviews: ReviewResult) {\n    const length = strlen(this.text);\n    const { ontologyConfigMap } = this.rootStore.ontology;\n\n    this.reviews.data = reviews.data || {};\n\n    if (reviews.missing) {\n      this.reviews.missing = reviews.missing.filter((label) => {\n        // invalid start & end\n        if (typeof (label) !== 'object') return false;\n        if (Number.isNaN(label.start) || label.start === null || label.start < 0 || label.start >= length) {\n          return false;\n        }\n        if (Number.isNaN(label.end) || label.end === null || label.end < 0 || label.end >= length) {\n          return false;\n        }\n        if (!label.keys) {\n          ontologyConfigMap.forEach((value, key) => {\n            const keys = value.keys;\n            if (keys[keys.length - 1] === label.value) {\n              label.keys = value.keys;\n            }\n          });\n        }\n        // invalid value\n        if (!isLabel(getConfigByKeys(ontologyConfigMap, label.keys)?.type)) {\n          return false;\n        }\n        // invalid & missing id\n        if (!label.id) {\n          label.id = uuidv4();\n        }\n        if (!label.type) {\n          label.type = TAG.LABEL_QA;\n        }\n        // missing text\n        if (!label.text) label.text = substr(this.text, label.start, label.end - label.start);\n        return true;\n      });\n    }\n  }\n\n  addMissingReview(newItem: MissingItem, id: string, data: ReviewDataItem) {\n    const { reviews } = this;\n\n    const { missing } = reviews;\n    missing.unshift(newItem as MissingItem);\n    missing.sort((a, b) => (a.start - b.start));\n\n    const preReview = reviews.data[id];\n    reviews.data[id] = data;\n    reviews.data = { ...reviews.data };\n    return { review: { ...data }, preReview, id, label: newItem };\n  }\n\n  setReview(id: string, data: ReviewDataItem) {\n    const { reviews } = this;\n    const preReview = reviews.data[id];\n    reviews.data[id] = data;\n    reviews.data = { ...reviews.data };\n    return { review: { ...data }, preReview, id };\n  }\n\n  getReview(id: string) {\n    if (!id) {\n      return null;\n    }\n    return this.reviews.data[id];\n  }\n\n  getReviews() {\n    const { missing, data } = this.reviews;\n    return {\n      data: toJS(data),\n      missing: missing?.map((item) => toJS(item)),\n    };\n  }\n\n  deleteReview(id: string) {\n    const reviewData = { ...this.reviews.data[id] };\n    delete this.reviews.data[id];\n    return { review: reviewData, id };\n  }\n\n  deleteReviews(ids: string[]) {\n    const reviewDataList: ({ review: ReviewDataItem; id: string })[] = [];\n    ids.forEach((id) => {\n      const reviewData = this.deleteReview(id);\n      reviewDataList.push({ ...reviewData, id });\n    });\n    return { reviewDataList };\n  }\n\n  deleteMissingReview(id: string) {\n    const { missing, data } = this.reviews;\n    const reviewData = { ...data[id] };\n\n    const index = findIndex(missing, { id });\n    const label = missing[index];\n    missing.splice(index, 1);\n    delete data[id];\n    return { review: reviewData, id, label };\n  }\n}\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module"}