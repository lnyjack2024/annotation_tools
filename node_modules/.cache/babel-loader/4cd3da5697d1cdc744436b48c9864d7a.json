{"ast":null,"code":"import React,{useEffect,useState,useMemo,useImperativeHandle,forwardRef}from'react';import{Base64}from'js-base64';import EasyForm from'@appen-china/easy-form';import{validate}from'@appen-china/easy-form/es/utils';import{parseFields}from'src/utils/form';import AttributeValueItem from'./AttributeValueItem';import'./AttributesConfig.scss';const AttributesConfig=forwardRef((_ref,ref)=>{let{config:defaultConfig,value:attributes,onChange,disabled}=_ref;if(!defaultConfig){return null;}const[formConfig,setFormConfig]=useState();useEffect(()=>{const configStr=Base64.decode(defaultConfig||'');if(configStr){try{const parsedConfig=JSON.parse(configStr);setFormConfig(parsedConfig);}catch(error){// parse error\nsetFormConfig(undefined);}}else{setFormConfig(undefined);}},[defaultConfig]);const fieldsMap=useMemo(()=>parseFields(formConfig),[formConfig]);// fields with initial value\nconst fieldsWithInitialValue=useMemo(()=>((formConfig===null||formConfig===void 0?void 0:formConfig.fields)||[]).map(field=>({...field,readonly:disabled||field.readonly,...(attributes&&attributes[field.name]!==undefined&&{defaultValue:attributes[field.name]})})),[formConfig,attributes]);const handleValuesChange=(changedValues,values)=>{if(!values||values.length===0){// empty form\nonChange(undefined);}else{onChange(values);}};const validateForm=()=>{if(formConfig){if(!attributes){return false;}return validate(formConfig,attributes);}return true;};useImperativeHandle(ref,()=>({validateForm}));const renderAttributes=()=>{const fieldKeys=Object.keys(fieldsMap);const attrKeys=attributes?Object.keys(attributes):[];const legacyKeys=attrKeys.filter(key=>!fieldKeys.includes(key));return/*#__PURE__*/React.createElement(React.Fragment,null,[...fieldKeys,...legacyKeys].map(key=>attrKeys.includes(key)&&/*#__PURE__*/React.createElement(AttributeValueItem,{key:key,fieldName:key,fieldsMap:fieldsMap,values:attributes})));};return/*#__PURE__*/React.createElement(\"div\",{className:\"llm-attributes-config\"},!disabled?/*#__PURE__*/React.createElement(EasyForm,{fields:fieldsWithInitialValue,conditions:formConfig===null||formConfig===void 0?void 0:formConfig.conditions,effects:formConfig===null||formConfig===void 0?void 0:formConfig.effects,rules:formConfig===null||formConfig===void 0?void 0:formConfig.rules,onChange:handleValuesChange,onSubmit:()=>{},footerVisible:false}):renderAttributes());});export default AttributesConfig;","map":{"version":3,"names":["React","useEffect","useState","useMemo","useImperativeHandle","forwardRef","Base64","EasyForm","validate","parseFields","AttributeValueItem","AttributesConfig","_ref","ref","config","defaultConfig","value","attributes","onChange","disabled","formConfig","setFormConfig","configStr","decode","parsedConfig","JSON","parse","error","undefined","fieldsMap","fieldsWithInitialValue","fields","map","field","readonly","name","defaultValue","handleValuesChange","changedValues","values","length","validateForm","renderAttributes","fieldKeys","Object","keys","attrKeys","legacyKeys","filter","key","includes","createElement","Fragment","fieldName","className","conditions","effects","rules","onSubmit","footerVisible"],"sources":["/Users/qzheng/Documents/webroot/annotation_tools/src/components/common/llm/attributes-config/AttributesConfig.tsx"],"sourcesContent":["import React, { useEffect, useState, useMemo, useImperativeHandle, forwardRef } from 'react';\nimport { Base64 } from 'js-base64';\nimport EasyForm from '@appen-china/easy-form';\nimport { FormConfig } from '@appen-china/easy-form/es/types';\nimport { validate } from '@appen-china/easy-form/es/utils';\nimport { parseFields } from 'src/utils/form';\nimport AttributeValueItem from './AttributeValueItem';\nimport './AttributesConfig.scss';\n\ninterface AttributesConfigProps {\n  config: string;\n  onChange: (val: any) => void;\n  disabled?: boolean;\n  value?: {[key: string]: any};\n}\nexport interface AttributesConfigHandle {\n  validateForm: () => boolean;\n}\n\nconst AttributesConfig = forwardRef<AttributesConfigHandle, AttributesConfigProps>(({ config: defaultConfig, value: attributes, onChange, disabled }, ref) => {\n  if (!defaultConfig) {\n    return null;\n  }\n  const [formConfig, setFormConfig] = useState<FormConfig>();\n\n  useEffect(() => {\n    const configStr = Base64.decode(defaultConfig || '');\n    if (configStr) {\n      try {\n        const parsedConfig = JSON.parse(configStr);\n        setFormConfig(parsedConfig);\n      } catch (error) {\n        // parse error\n        setFormConfig(undefined);\n      }\n    } else {\n      setFormConfig(undefined);\n    }\n  }, [defaultConfig]);\n\n  const fieldsMap = useMemo(() => parseFields(formConfig), [formConfig]);\n  // fields with initial value\n  const fieldsWithInitialValue = useMemo(() => (formConfig?.fields || []).map((field) => ({\n    ...field,\n    readonly: disabled || field.readonly,\n    ...attributes && attributes[field.name] !== undefined && {\n      defaultValue: attributes[field.name],\n    }\n  })), [formConfig, attributes]);\n\n  const handleValuesChange = (changedValues:any, values: any) => {\n    if (!values || values.length === 0) {\n      // empty form\n      onChange(undefined);\n    } else {\n      onChange(values);\n    }\n  };\n\n  const validateForm = () => {\n    if (formConfig) {\n      if (!attributes) {\n        return false;\n      }\n      return validate(formConfig, attributes);\n    }\n    return true;\n  };\n\n  useImperativeHandle(ref, () => ({\n    validateForm\n  }));\n\n  const renderAttributes = () => {\n    const fieldKeys = Object.keys(fieldsMap);\n    const attrKeys = attributes ? Object.keys(attributes) : [];\n    const legacyKeys = attrKeys.filter((key) => !fieldKeys.includes(key));\n\n    return (\n      <>\n        {\n          [...fieldKeys, ...legacyKeys].map((key) => attrKeys.includes(key) && (\n            <AttributeValueItem\n              key={key}\n              fieldName={key}\n              fieldsMap={fieldsMap}\n              values={attributes}\n            />\n          ))\n        }\n      </>\n    );\n  };\n\n  return (\n    <div className=\"llm-attributes-config\">\n      {!disabled ? (\n        <EasyForm\n          fields={fieldsWithInitialValue}\n          conditions={formConfig?.conditions}\n          effects={formConfig?.effects}\n          rules={formConfig?.rules}\n          onChange={handleValuesChange}\n          onSubmit={() => {}}\n          footerVisible={false}\n        />\n      ) : renderAttributes()}\n    </div>\n  );\n});\nexport default AttributesConfig;\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module"}