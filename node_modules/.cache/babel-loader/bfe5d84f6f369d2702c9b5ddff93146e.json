{"ast":null,"code":"import React from 'react';\nimport { isEqual } from 'lodash';\nimport { checkRunningMode } from '../../utils';\nimport { RunningMode } from '../../types';\nconst DEFAULT_INTERVAL = 2 * 60 * 1000; // 2 mins\n\nconst beforeUnload = event => {\n  event.preventDefault();\n  // eslint-disable-next-line no-param-reassign\n  event.returnValue = '';\n};\nexport default class AutoSaver extends React.Component {\n  constructor(...args) {\n    super(...args);\n    this.autoSaveTimer = void 0;\n    this.tempSaved = true;\n  }\n  componentDidMount() {\n    if (checkRunningMode() === RunningMode.IFRAME) {\n      this.autoSaveTimer = window.setInterval(async () => {\n        if (!this.tempSaved) {\n          try {\n            await this.props.save();\n            this.setTempSaved(true);\n            if (this.props.onSaved) {\n              this.props.onSaved();\n            }\n          } catch (e) {\n            // save fail\n          }\n        }\n      }, this.props.interval || DEFAULT_INTERVAL);\n    }\n  }\n  componentDidUpdate(prevProps) {\n    if (this.tempSaved && !isEqual(prevProps.data, this.props.data)) {\n      // when tempSaved is true and data has been changed, need auto save\n      this.setTempSaved(false);\n    }\n  }\n  componentWillUnmount() {\n    if (this.autoSaveTimer) {\n      window.clearInterval(this.autoSaveTimer);\n    }\n    this.disableLeaveCheck();\n  }\n  setTempSaved(tempSaved) {\n    this.tempSaved = tempSaved;\n    if (this.props.leaveCheck && checkRunningMode() === RunningMode.IFRAME) {\n      if (this.tempSaved) {\n        this.disableLeaveCheck();\n      } else {\n        this.enableLeaveCheck();\n      }\n    }\n  }\n\n  // eslint-disable-next-line class-methods-use-this\n  disableLeaveCheck() {\n    window.removeEventListener('beforeunload', beforeUnload);\n  }\n\n  // eslint-disable-next-line class-methods-use-this\n  enableLeaveCheck() {\n    window.addEventListener('beforeunload', beforeUnload);\n  }\n  render() {\n    return null;\n  }\n}","map":{"version":3,"names":["React","isEqual","checkRunningMode","RunningMode","DEFAULT_INTERVAL","beforeUnload","event","preventDefault","returnValue","AutoSaver","Component","constructor","args","autoSaveTimer","tempSaved","componentDidMount","IFRAME","window","setInterval","props","save","setTempSaved","onSaved","e","interval","componentDidUpdate","prevProps","data","componentWillUnmount","clearInterval","disableLeaveCheck","leaveCheck","enableLeaveCheck","removeEventListener","addEventListener","render"],"sources":["/Users/qzheng/Documents/webroot/annotation_tools/src/components/common/AutoSaver.tsx"],"sourcesContent":["import React from 'react';\nimport { isEqual } from 'lodash';\nimport { checkRunningMode } from '../../utils';\nimport { RunningMode } from '../../types';\n\nconst DEFAULT_INTERVAL = 2 * 60 * 1000; // 2 mins\n\ninterface AutoSaverProps {\n  interval?: number;\n  leaveCheck?: boolean;\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  data: any;\n  save: () => void;\n  onSaved?: () => void;\n}\n\nconst beforeUnload = (event: BeforeUnloadEvent) => {\n  event.preventDefault();\n  // eslint-disable-next-line no-param-reassign\n  event.returnValue = '';\n};\n\nexport default class AutoSaver extends React.Component<AutoSaverProps> {\n  autoSaveTimer: number | undefined;\n\n  tempSaved = true;\n\n  componentDidMount() {\n    if (checkRunningMode() === RunningMode.IFRAME) {\n      this.autoSaveTimer = window.setInterval(async () => {\n        if (!this.tempSaved) {\n          try {\n            await this.props.save();\n            this.setTempSaved(true);\n            if (this.props.onSaved) {\n              this.props.onSaved();\n            }\n          } catch (e) {\n            // save fail\n          }\n        }\n      }, this.props.interval || DEFAULT_INTERVAL);\n    }\n  }\n\n  componentDidUpdate(prevProps: AutoSaverProps) {\n    if (this.tempSaved && !isEqual(prevProps.data, this.props.data)) {\n      // when tempSaved is true and data has been changed, need auto save\n      this.setTempSaved(false);\n    }\n  }\n\n  componentWillUnmount() {\n    if (this.autoSaveTimer) {\n      window.clearInterval(this.autoSaveTimer);\n    }\n    this.disableLeaveCheck();\n  }\n\n  setTempSaved(tempSaved: boolean) {\n    this.tempSaved = tempSaved;\n    if (this.props.leaveCheck && checkRunningMode() === RunningMode.IFRAME) {\n      if (this.tempSaved) {\n        this.disableLeaveCheck();\n      } else {\n        this.enableLeaveCheck();\n      }\n    }\n  }\n\n  // eslint-disable-next-line class-methods-use-this\n  disableLeaveCheck() {\n    window.removeEventListener('beforeunload', beforeUnload);\n  }\n\n  // eslint-disable-next-line class-methods-use-this\n  enableLeaveCheck() {\n    window.addEventListener('beforeunload', beforeUnload);\n  }\n\n  render() {\n    return null;\n  }\n}\n"],"mappings":"AAAA,OAAOA,KAAK,MAAM,OAAO;AACzB,SAASC,OAAO,QAAQ,QAAQ;AAChC,SAASC,gBAAgB,QAAQ,aAAa;AAC9C,SAASC,WAAW,QAAQ,aAAa;AAEzC,MAAMC,gBAAgB,GAAG,CAAC,GAAG,EAAE,GAAG,IAAI,CAAC,CAAC;;AAWxC,MAAMC,YAAY,GAAIC,KAAwB,IAAK;EACjDA,KAAK,CAACC,cAAc,CAAC,CAAC;EACtB;EACAD,KAAK,CAACE,WAAW,GAAG,EAAE;AACxB,CAAC;AAED,eAAe,MAAMC,SAAS,SAAST,KAAK,CAACU,SAAS,CAAiB;EAAAC,YAAA,GAAAC,IAAA;IAAA,SAAAA,IAAA;IAAA,KACrEC,aAAa;IAAA,KAEbC,SAAS,GAAG,IAAI;EAAA;EAEhBC,iBAAiBA,CAAA,EAAG;IAClB,IAAIb,gBAAgB,CAAC,CAAC,KAAKC,WAAW,CAACa,MAAM,EAAE;MAC7C,IAAI,CAACH,aAAa,GAAGI,MAAM,CAACC,WAAW,CAAC,YAAY;QAClD,IAAI,CAAC,IAAI,CAACJ,SAAS,EAAE;UACnB,IAAI;YACF,MAAM,IAAI,CAACK,KAAK,CAACC,IAAI,CAAC,CAAC;YACvB,IAAI,CAACC,YAAY,CAAC,IAAI,CAAC;YACvB,IAAI,IAAI,CAACF,KAAK,CAACG,OAAO,EAAE;cACtB,IAAI,CAACH,KAAK,CAACG,OAAO,CAAC,CAAC;YACtB;UACF,CAAC,CAAC,OAAOC,CAAC,EAAE;YACV;UAAA;QAEJ;MACF,CAAC,EAAE,IAAI,CAACJ,KAAK,CAACK,QAAQ,IAAIpB,gBAAgB,CAAC;IAC7C;EACF;EAEAqB,kBAAkBA,CAACC,SAAyB,EAAE;IAC5C,IAAI,IAAI,CAACZ,SAAS,IAAI,CAACb,OAAO,CAACyB,SAAS,CAACC,IAAI,EAAE,IAAI,CAACR,KAAK,CAACQ,IAAI,CAAC,EAAE;MAC/D;MACA,IAAI,CAACN,YAAY,CAAC,KAAK,CAAC;IAC1B;EACF;EAEAO,oBAAoBA,CAAA,EAAG;IACrB,IAAI,IAAI,CAACf,aAAa,EAAE;MACtBI,MAAM,CAACY,aAAa,CAAC,IAAI,CAAChB,aAAa,CAAC;IAC1C;IACA,IAAI,CAACiB,iBAAiB,CAAC,CAAC;EAC1B;EAEAT,YAAYA,CAACP,SAAkB,EAAE;IAC/B,IAAI,CAACA,SAAS,GAAGA,SAAS;IAC1B,IAAI,IAAI,CAACK,KAAK,CAACY,UAAU,IAAI7B,gBAAgB,CAAC,CAAC,KAAKC,WAAW,CAACa,MAAM,EAAE;MACtE,IAAI,IAAI,CAACF,SAAS,EAAE;QAClB,IAAI,CAACgB,iBAAiB,CAAC,CAAC;MAC1B,CAAC,MAAM;QACL,IAAI,CAACE,gBAAgB,CAAC,CAAC;MACzB;IACF;EACF;;EAEA;EACAF,iBAAiBA,CAAA,EAAG;IAClBb,MAAM,CAACgB,mBAAmB,CAAC,cAAc,EAAE5B,YAAY,CAAC;EAC1D;;EAEA;EACA2B,gBAAgBA,CAAA,EAAG;IACjBf,MAAM,CAACiB,gBAAgB,CAAC,cAAc,EAAE7B,YAAY,CAAC;EACvD;EAEA8B,MAAMA,CAAA,EAAG;IACP,OAAO,IAAI;EACb;AACF","ignoreList":[]},"metadata":{},"sourceType":"module"}